<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—©æŠ¼ã—ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap');

:root {
    /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ - ãƒ¢ãƒãƒˆãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹ */
    --bg-primary: #ffffff;
    --bg-secondary: #fafafa;
    --bg-tertiary: #f5f5f5;
    --bg-card: rgba(255, 255, 255, 0.95);
    --bg-glass: rgba(255, 255, 255, 0.8);
    
    --text-primary: #0a0a0a;
    --text-secondary: #525252;
    --text-muted: #a3a3a3;
    --text-light: #ffffff;
    
    --accent-primary: #000000;
    --accent-secondary: #404040;
    --accent-success: #16a34a;
    --accent-warning: #f59e0b;
    --accent-danger: #dc2626;
    --accent-info: #3b82f6;
    
    --border-light: #e5e5e5;
    --border-medium: #d4d4d4;
    --border-dark: #525252;
    
    --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.05);
    --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-heavy: 0 10px 25px rgba(0, 0, 0, 0.12);
    
    --border-radius: 12px;
    --border-radius-lg: 16px;
    --border-radius-xl: 24px;
    
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
@media (prefers-color-scheme: dark) {
    :root {
        --bg-primary: #0a0a0a;
        --bg-secondary: #171717;
        --bg-tertiary: #262626;
        --bg-card: rgba(23, 23, 23, 0.95);
        --bg-glass: rgba(23, 23, 23, 0.8);
        
        --text-primary: #fafafa;
        --text-secondary: #a3a3a3;
        --text-muted: #525252;
        
        --accent-primary: #ffffff;
        --accent-secondary: #d4d4d4;
        
        --border-light: #262626;
        --border-medium: #404040;
        --border-dark: #a3a3a3;
        
        --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.3);
        --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.4);
        --shadow-heavy: 0 10px 25px rgba(0, 0, 0, 0.6);
    }
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    min-height: 100vh;
    color: var(--text-primary);
    line-height: 1.6;
    font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
    position: relative;
}

/* èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ */
body::before {
    --size: 40px;
    --line: color-mix(in hsl, var(--text-primary), transparent 90%);
    content: '';
    height: 100vh;
    width: 100vw;
    position: fixed;
    background: 
        linear-gradient(90deg, var(--line) 1px, transparent 1px var(--size)) 50% 50% / var(--size) var(--size),
        linear-gradient(var(--line) 1px, transparent 1px var(--size)) 50% 50% / var(--size) var(--size);
    mask: linear-gradient(-15deg, transparent 40%, white);
    top: 0;
    transform-style: flat;
    pointer-events: none;
    z-index: -1;
    opacity: 0.3;
}

.main-container {
    position: relative;
    z-index: 2;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.container {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-xl);
    padding: 3rem;
    box-shadow: var(--shadow-heavy);
    max-width: 900px;
    width: 100%;
    position: relative;
}

/* ã‚¿ã‚¤ãƒˆãƒ« */
h1 {
    font-size: clamp(2.5rem, 8vw, 5rem);
    font-weight: 600;
    text-align: center;
    line-height: 0.9;
    margin-bottom: 3rem;
    background: linear-gradient(
        var(--text-primary) 60%,
        color-mix(in oklch, var(--bg-primary), var(--text-primary) 40%)
    );
    background-clip: text;
    -webkit-background-clip: text;
    color: transparent;
    text-wrap: pretty;
    letter-spacing: -0.02em;
}

h2 {
    font-size: 2rem;
    font-weight: 300;
    color: var(--text-primary);
    margin-bottom: 2rem;
    text-align: center;
    letter-spacing: -0.01em;
}

h3 {
    font-size: 1.2rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 1rem;
}

.screen {
    display: none;
    animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.screen.active {
    display: block;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.countdown-screen {
    text-align: center;
    padding: 4rem 2rem;
}

.countdown-number {
    font-size: clamp(8rem, 20vw, 15rem);
    font-weight: 100;
    color: var(--accent-primary);
    margin: 2rem 0;
    animation: countdownPulse 1s ease-in-out;
    font-feature-settings: 'tnum';
    line-height: 1;
}

.countdown-text {
    font-size: 1.5rem;
    font-weight: 400;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

.countdown-question-info {
    font-size: 1.2rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-top: 2rem;
}

@keyframes countdownPulse {
    0% {
        transform: scale(0.8);
        opacity: 0;
    }
    50% {
        transform: scale(1.1);
        opacity: 1;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚«ãƒ¼ãƒ‰ */
.mode-selection {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.mode-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.mode-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--accent-primary);
    opacity: 0;
    transition: var(--transition);
}

.mode-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-heavy);
    border-color: var(--accent-primary);
}

.mode-card:hover::before {
    opacity: 0.03;
}

.mode-card .icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
}

.mode-card h3 {
    font-size: 1.3rem;
    margin-bottom: 0.5rem;
    font-weight: 500;
    position: relative;
    z-index: 1;
}

.mode-card p {
    color: var(--text-secondary);
    font-size: 0.95rem;
    position: relative;
    z-index: 1;
}

/* ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰è¨­å®š */
.practice-settings {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-light);
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.checkbox-item:hover {
    background: var(--bg-tertiary);
}

.checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* çµ±è¨ˆæƒ…å ± */
.practice-stats {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin: 2rem 0;
    border: 1px solid var(--border-light);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.stat-item {
    background: var(--bg-primary);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    text-align: center;
    border: 1px solid var(--border-light);
    transition: var(--transition);
}

.stat-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.stat-label {
    display: block;
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.stat-value {
    display: block;
    color: var(--accent-primary);
    font-size: 2rem;
    font-weight: 600;
    font-feature-settings: 'tnum';
}

/* å¾©ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.review-section {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin: 2rem 0;
    border: 1px solid var(--border-light);
}

.review-question {
    background: var(--bg-primary);
    padding: 1.5rem;
    margin: 1rem 0;
    border-radius: var(--border-radius);
    border: 1px solid var(--border-light);
}

.review-question-text {
    font-weight: 500;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.review-choices {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.review-choice {
    padding: 0.5rem 1rem;
    border-radius: var(--border-radius);
    font-size: 0.9rem;
}

.review-choice.correct {
    background: color-mix(in oklch, var(--accent-success), transparent 90%);
    color: var(--accent-success);
    border: 1px solid var(--accent-success);
}

.review-choice.incorrect {
    background: color-mix(in oklch, var(--accent-danger), transparent 90%);
    color: var(--accent-danger);
    border: 1px solid var(--accent-danger);
}

.review-choice.neutral {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border: 1px solid var(--border-light);
}

/* ç·´ç¿’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
.practice-controls {
    text-align: center;
    margin: 2rem 0;
}

/* è§£èª¬ã‚¨ãƒªã‚¢ */
.explanation {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-top: 2rem;
    border: 1px solid var(--border-light);
    border-left: 4px solid var(--accent-info);
}

.explanation h4 {
    color: var(--accent-info);
    margin-bottom: 1rem;
}

#explanationText {
    color: var(--text-primary);
    line-height: 1.6;
}

/* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
.btn {
    font-family: inherit;
    font-weight: 500;
    font-size: 0.95rem;
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--border-medium);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin: 0.25rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--accent-primary);
    opacity: 0;
    transition: var(--transition);
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-medium);
    border-color: var(--accent-primary);
}

.btn:hover::before {
    opacity: 0.05;
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: var(--accent-primary);
    color: var(--bg-primary);
    border-color: var(--accent-primary);
}

.btn-primary:hover {
    background: var(--accent-secondary);
    border-color: var(--accent-secondary);
    color: var(--bg-primary);
}

.btn-success {
    background: var(--accent-success);
    color: var(--text-light);
    border-color: var(--accent-success);
}

.btn-danger {
    background: var(--accent-danger);
    color: var(--text-light);
    border-color: var(--accent-danger);
}

.btn-warning {
    background: var(--accent-warning);
    color: var(--text-light);
    border-color: var(--accent-warning);
}

.btn-secondary {
    background: var(--accent-secondary);
    color: var(--text-light);
    border-color: var(--accent-secondary);
}

.btn-info {
    background: var(--accent-info);
    color: var(--text-light);
    border-color: var(--accent-info);
}

/* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-medium);
    border-radius: var(--border-radius);
    font-size: 0.95rem;
    transition: var(--transition);
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: inherit;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px color-mix(in oklch, var(--accent-primary), transparent 90%);
}

/* ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ */
.category-selection {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.category-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius);
    padding: 1.5rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    color: var(--text-muted);
}

.category-item:hover {
    transform: translateY(-2px);
    border-color: var(--accent-primary);
    box-shadow: var(--shadow-medium);
    color: var(--text-primary);
}

.category-item.selected {
    background: var(--accent-primary);
    color: var(--text-light);
    border-color: var(--accent-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.category-item h4 {
    font-size: 1rem;
    font-weight: 500;
    margin: 0;
}

/* ã‚¯ã‚¤ã‚ºç”»é¢ */
.quiz-header {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: center;
    border: 1px solid var(--border-light);
}

.question-number {
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

.timer {
    font-size: 3rem;
    font-weight: 100;
    color: var(--accent-primary);
    margin-bottom: 1rem;
    font-feature-settings: 'tnum';
}

.game-mode-info {
    font-size: 0.9rem;
    font-weight: 400;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    padding: 1rem;
    border-radius: var(--border-radius);
    margin-top: 1rem;
    border: 1px solid var(--border-light);
}

.question {
    font-size: 1.4rem;
    font-weight: 400;
    line-height: 1.5;
    margin-bottom: 2rem;
    text-align: center;
    padding: 2rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-radius: var(--border-radius-lg);
    letter-spacing: -0.01em;
    border: 1px solid var(--border-light);
}

.choices {
    display: grid;
    gap: 1rem;
    margin-bottom: 2rem;
}

.choice {
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius);
    padding: 1.25rem;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 400;
}

.choice:hover {
    transform: translateY(-2px);
    border-color: var(--accent-primary);
    box-shadow: var(--shadow-medium);
}

.choice.selected {
    border-color: var(--accent-primary);
    background: color-mix(in oklch, var(--accent-primary), transparent 95%);
}

.choice.correct {
    background: var(--accent-success);
    color: var(--text-light);
    border-color: var(--accent-success);
    animation: correctAnswer 0.6s ease-in-out;
}

.choice.incorrect {
    background: var(--accent-danger);
    color: var(--text-light);
    border-color: var(--accent-danger);
    animation: incorrectAnswer 0.6s ease-in-out;
}

.choice.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç† */
.player-list,
.online-players {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 1.5rem 0;
    border: 1px solid var(--border-light);
}

.player-item,
.online-player {
    background: var(--bg-primary);
    padding: 1rem 1.25rem;
    margin: 0.75rem 0;
    border-radius: var(--border-radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border-light);
    transition: var(--transition);
    color: var(--text-primary);
}

.player-item:hover,
.online-player:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-medium);
}

.player-item.ready,
.online-player.ready {
    border-color: var(--accent-success);
    background: color-mix(in oklch, var(--accent-success), transparent 95%);
}

/* ãƒ«ãƒ¼ãƒ æƒ…å ± */
.room-info {
    background: transparent;
    color: var(--text-primary);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    text-align: center;
    font-size: 2.2rem;
    font-weight: 400;
    letter-spacing: 0.05em;
}

/* ãƒ©ãƒ™ãƒ« */
.you-label,
.host-label {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 0.5rem;
}

.you-label {
    background: var(--accent-success);
    color: var(--text-light);
}

.host-label {
    background: var(--accent-warning);
    color: var(--text-light);
}

.ready-status {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-weight: 400;
}

.player-item.ready .ready-status,
.online-player.ready .ready-status {
    color: var(--text-light);
    font-weight: 500;
    background: var(--accent-success);
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
}

/* å›ç­”ãƒ­ã‚° */
.answer-log {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-top: 2rem;
    border: 1px solid var(--border-light);
}

.answer-log h4 {
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 500;
}

.answer-item {
    background: var(--bg-primary);
    padding: 1rem 1.25rem;
    margin: 0.75rem 0;
    border-radius: var(--border-radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border-light);
    transition: var(--transition);
}

.answer-item:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-medium);
}

.answer-item.correct {
    border-color: var(--accent-success);
    background: color-mix(in oklch, var(--accent-success), transparent 95%);
}

.answer-item.incorrect {
    border-color: var(--accent-danger);
    background: color-mix(in oklch, var(--accent-danger), transparent 95%);
}

/* çµæœç”»é¢ */
.results {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    border: 1px solid var(--border-light);
}

.rank-item {
    background: var(--bg-primary);
    padding: 1.5rem;
    margin: 1rem 0;
    border-radius: var(--border-radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border-light);
    transition: var(--transition);
    color: var(--text-primary);
}

.rank-1 {
    background: #fef3c7;
    border-color: #f59e0b;
    font-weight: 600;
    color: #92400e;
}

.rank-2 {
    background: #f3f4f6;
    border-color: #9ca3af;
    font-weight: 500;
    color: #374151;
}

.rank-3 {
    background: #fef2e2;
    border-color: #f97316;
    font-weight: 500;
    color: #c2410c;
}

.rank-item:hover {
    transform: translateX(8px);
    box-shadow: var(--shadow-medium);
}

/* å•é¡Œä½œæˆ */
.question-form {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-light);
}

.question-list {
    max-height: 400px;
    overflow-y: auto;
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-top: 2rem;
    border: 1px solid var(--border-light);
}

.question-item {
    background: var(--bg-primary);
    padding: 1.5rem;
    margin: 1rem 0;
    border-radius: var(--border-radius);
    border: 1px solid var(--border-light);
    color: var(--text-primary);
}

/* ã‚»ãƒ³ã‚¿ãƒ¼é…ç½® */
.center {
    text-align: center;
    margin: 2rem 0;
}

/* æ¥ç¶šçŠ¶æ…‹ */
.connection-status {
    position: fixed;
    top: 2rem;
    left: 2rem;
    padding: 0.75rem 1rem;
    border-radius: 25px;
    font-size: 0.85rem;
    font-weight: 500;
    z-index: 1000;
    border: 1px solid var(--border-light);
    backdrop-filter: blur(20px);
    box-shadow: var(--shadow-medium);
}

.connection-status.connected {
    background: color-mix(in oklch, var(--accent-success), transparent 90%);
    color: var(--accent-success);
    border-color: var(--accent-success);
}

.connection-status.disconnected {
    background: color-mix(in oklch, var(--accent-danger), transparent 90%);
    color: var(--accent-danger);
    border-color: var(--accent-danger);
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
@media (max-width: 768px) {
    .main-container {
        padding: 1rem;
    }
    
    .container {
        padding: 2rem;
    }
    
    h1 {
        font-size: clamp(2rem, 6vw, 3.5rem);
    }
    
    .mode-selection {
        grid-template-columns: 1fr;
    }
    
    .category-selection {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .countdown-number {
        font-size: clamp(5rem, 15vw, 10rem);
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
}

/* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
::placeholder {
    color: var(--text-muted);
    opacity: 1;
}

/* ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ */
::selection {
    background: color-mix(in oklch, var(--accent-primary), transparent 80%);
}

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤º */
:focus-visible {
    outline: 2px solid var(--accent-primary);
    outline-offset: 2px;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
.loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border-light);
    border-radius: 50%;
    border-top-color: var(--accent-primary);
    animation: spin 1s linear infinite;
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

@keyframes glow {
    0%, 100% { box-shadow: var(--shadow-medium); }
    50% { box-shadow: var(--shadow-medium), var(--shadow-glow); }
}

@keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

@keyframes choiceSelect {
    0% { transform: scale(1); }
    30% { transform: scale(1.05); }
    60% { transform: scale(0.98); }
    100% { transform: scale(1.02); }
}

@keyframes correctAnswer {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

@keyframes incorrectAnswer {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* ãƒ—ãƒªãƒ³ãƒˆç”¨ */
@media print {
    body::before {
        display: none;
    }
}
    </style>
</head>
<body>
    <!-- æ¥ç¶šçŠ¶æ…‹ -->
    <div class="connection-status disconnected" id="connectionStatus" style="display: none;">
        âŒ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³
    </div>

    <div class="main-container">
        <div class="container">
            <h1>ğŸ’¡ ã‚¯ã‚¤ã‚ºå¤§ä¼š</h1>

            <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
            <div id="homeScreen" class="screen active">
                <div class="mode-selection">
                    <div class="mode-card" onclick="startPracticeMode()">
                        <span class="icon">ğŸ¯</span>
                        <h3>ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</h3>
                        <p>ä¸€äººã§ã˜ã£ãã‚Šå•é¡Œã«æŒ‘æˆ¦ã—ã‚ˆã†</p>
                    </div>
                    <div class="mode-card" onclick="startLocalGame()">
                        <span class="icon">ğŸ </span>
                        <h3>ãƒ­ãƒ¼ã‚«ãƒ«å¯¾æˆ¦</h3>
                        <p>åŒã˜ç«¯æœ«ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦ã‚’æ¥½ã—ã‚‚ã†</p>
                    </div>
                    <div class="mode-card" onclick="showOnlineMenu()">
                        <span class="icon">ğŸŒ</span>
                        <h3>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</h3>
                        <p>ä¸–ç•Œä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ç™½ç†±ãƒãƒˆãƒ«</p>
                    </div>
                </div>
                <div class="center">
                    <button class="btn btn-warning" onclick="showQuestionCreator()">
                        âœï¸ ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <!-- ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰è¨­å®šç”»é¢ -->
            <div id="practiceModeScreen" class="screen">
                <h2>ğŸ¯ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰è¨­å®š</h2>
                
                <div class="practice-settings">
                    <div class="form-group">
                        <label>â±ï¸ åˆ¶é™æ™‚é–“</label>
                        <select id="practiceTimeLimit">
                            <option value="10">10ç§’</option>
                            <option value="15" selected>15ç§’</option>
                            <option value="20">20ç§’</option>
                            <option value="30">30ç§’</option>
                            <option value="-1">åˆ¶é™ãªã—</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ“Š å•é¡Œæ•°</label>
                        <select id="practiceQuestionCount">
                            <option value="5">5å•</option>
                            <option value="10" selected>10å•</option>
                            <option value="15">15å•</option>
                            <option value="20">20å•</option>
                            <option value="-1">å…¨å•é¡Œ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ”„ å•é¡Œé †åº</label>
                        <select id="practiceQuestionOrder">
                            <option value="random" selected>ãƒ©ãƒ³ãƒ€ãƒ </option>
                            <option value="category">ã‚«ãƒ†ã‚´ãƒªé †</option>
                            <option value="difficulty">é›£æ˜“åº¦é †</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ“ˆ çµæœè¡¨ç¤º</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="showAnswerExplanation" checked>
                                <span>è§£èª¬ã‚’è¡¨ç¤º</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="showStatistics" checked>
                                <span>çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="reviewIncorrect" checked>
                                <span>é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <p style="text-align: center; color: var(--text-secondary); margin: 2rem 0;">
                    æŒ‘æˆ¦ã—ãŸã„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯èƒ½ï¼‰
                </p>
                <div class="category-selection" id="practiceCategorySelection">
                    <div class="category-item" data-category="general" onclick="togglePracticeCategory('general')">
                        <h4>ğŸ“š ä¸€èˆ¬å¸¸è­˜</h4>
                    </div>
                    <div class="category-item" data-category="geography" onclick="togglePracticeCategory('geography')">
                        <h4>ğŸŒ åœ°ç†</h4>
                    </div>
                    <div class="category-item" data-category="history" onclick="togglePracticeCategory('history')">
                        <h4>ğŸ“œ æ­´å²</h4>
                    </div>
                    <div class="category-item" data-category="science" onclick="togglePracticeCategory('science')">
                        <h4>ğŸ”¬ ç§‘å­¦</h4>
                    </div>
                    <div class="category-item" data-category="sports" onclick="togglePracticeCategory('sports')">
                        <h4>âš½ ã‚¹ãƒãƒ¼ãƒ„</h4>
                    </div>
                    <div class="category-item" data-category="entertainment" onclick="togglePracticeCategory('entertainment')">
                        <h4>ğŸ¬ ã‚¨ãƒ³ã‚¿ãƒ¡</h4>
                    </div>
                    <div class="category-item" data-category="custom" onclick="togglePracticeCategory('custom')">
                        <h4>âœï¸ ã‚«ã‚¹ã‚¿ãƒ </h4>
                    </div>
                </div>
                
                <div class="center">
                    <button class="btn btn-success" onclick="startPracticeGame()">
                        ğŸš€ ç·´ç¿’é–‹å§‹
                    </button>
                    <button class="btn btn-danger" onclick="showHome()">
                        â† æˆ»ã‚‹
                    </button>
                </div>
            </div>

            <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <div id="onlineMenuScreen" class="screen">
                <h2>ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</h2>
                <div class="form-group">
                    <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
                    <input type="text" id="onlinePlayerName" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
                <div class="center">
                    <button class="btn btn-success" onclick="createRoom()">
                        ğŸ—ï¸ ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
                    </button>
                    <button class="btn btn-primary" onclick="showJoinRoom()">
                        ğŸšª ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
                    </button>
                    <button class="btn btn-danger" onclick="showHome()">
                        â† æˆ»ã‚‹
                    </button>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒ å‚åŠ ç”»é¢ -->
            <div id="joinRoomScreen" class="screen">
                <h2>ğŸšª ãƒ«ãƒ¼ãƒ å‚åŠ </h2>
                <div class="form-group">
                    <label>ãƒ«ãƒ¼ãƒ ID</label>
                    <input type="text" id="roomIdInput" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
                <div class="center">
                    <button class="btn btn-success" onclick="joinRoom()">
                        âœ¨ å‚åŠ ã™ã‚‹
                    </button>
                    <button class="btn btn-danger" onclick="showOnlineMenu()">
                        â† æˆ»ã‚‹
                    </button>
                </div>
            </div>

            <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾…æ©Ÿå®¤ -->
            <div id="onlineWaitingScreen" class="screen">
                <h2>ğŸ›ï¸ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾…æ©Ÿå®¤</h2>
                <div id="roomIdDisplay" class="room-info"></div>
                
                <div class="player-section">
                    <h3>ğŸ­ å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h3>
                    <div id="onlinePlayerList"></div>
                </div>
                
                <div class="center">
                    <button class="btn btn-primary" onclick="togglePlayerReady()">
                        ğŸ¯ æº–å‚™å®Œäº†/è§£é™¤
                    </button>
                    <button id="startOnlineGameBtn" class="btn btn-success" onclick="startOnlineGame()" style="display: none;">
                        ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹
                    </button>
                    <button class="btn btn-secondary" onclick="leaveOnlineRoom()">
                        ğŸšª ãƒ«ãƒ¼ãƒ é€€å‡º
                    </button>
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²ç”»é¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ -->
            <div id="playerScreen" class="screen">
                <h2>ğŸ‘¥ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²</h2>
                <div class="form-group">
                    <input type="text" id="playerName" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" onkeypress="if(event.key==='Enter')addPlayer()">
                </div>
                <button class="btn btn-success" onclick="addPlayer()">
                    â• ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
                </button>
                
                <div class="player-list">
                    <h3>ğŸ­ å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h3>
                    <div id="playerList"></div>
                </div>
                
                <div class="center">
                    <button class="btn btn-primary" onclick="showCategorySelection()" id="startBtn" style="display:none;">
                        â­ï¸ æ¬¡ã¸
                    </button>
                    <button class="btn btn-danger" onclick="showHome()">
                        â† æˆ»ã‚‹
                    </button>
                </div>
            </div>

            <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠç”»é¢ -->
            <div id="categoryScreen" class="screen">
                <h2>ğŸ“š ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ</h2>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">
                    æŒ‘æˆ¦ã—ãŸã„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯èƒ½ï¼‰
                </p>
                <div class="category-selection" id="categorySelection">
                    <div class="category-item" data-category="general" onclick="toggleCategory('general')">
                        <h4>ğŸ“š ä¸€èˆ¬å¸¸è­˜</h4>
                    </div>
                    <div class="category-item" data-category="geography" onclick="toggleCategory('geography')">
                        <h4>ğŸŒ åœ°ç†</h4>
                    </div>
                    <div class="category-item" data-category="history" onclick="toggleCategory('history')">
                        <h4>ğŸ“œ æ­´å²</h4>
                    </div>
                    <div class="category-item" data-category="science" onclick="toggleCategory('science')">
                        <h4>ğŸ”¬ ç§‘å­¦</h4>
                    </div>
                    <div class="category-item" data-category="sports" onclick="toggleCategory('sports')">
                        <h4>âš½ ã‚¹ãƒãƒ¼ãƒ„</h4>
                    </div>
                    <div class="category-item" data-category="entertainment" onclick="toggleCategory('entertainment')">
                        <h4>ğŸ¬ ã‚¨ãƒ³ã‚¿ãƒ¡</h4>
                    </div>
                    <div class="category-item" data-category="custom" onclick="toggleCategory('custom')">
                        <h4>âœï¸ ã‚«ã‚¹ã‚¿ãƒ </h4>
                    </div>
                </div>
                <div class="center">
                    <button class="btn btn-success" onclick="startGameWithCategories()">
                        ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹
                    </button>
                    <button class="btn btn-danger" onclick="showPlayerRegistration()">
                        â† æˆ»ã‚‹
                    </button>
                </div>
            </div>

            <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç”»é¢ -->
            <div id="countdownScreen" class="screen">
                <div class="countdown-screen">
                    <div class="countdown-text">æ¬¡ã®å•é¡Œã¾ã§</div>
                    <div class="countdown-number" id="countdownNumber">5</div>
                    <div class="countdown-question-info" id="countdownQuestionInfo">ç¬¬1å• æº–å‚™ä¸­...</div>
                </div>
            </div>

            <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
            <div id="quizScreen" class="screen">
                <div class="quiz-header">
                    <div class="question-number" id="questionNumber">ç¬¬1å• / 6å•</div>
                    <div class="timer" id="timer">15</div>
                    <div class="game-mode-info" id="gameModeInfo">
                        âš¡ æ­£è§£è€…å…¨å“¡ã«ãƒã‚¤ãƒ³ãƒˆï¼æ—©æŠ¼ã—ã§é«˜å¾—ç‚¹ã‚’ç‹™ãˆï¼
                    </div>
                </div>
                
                <div class="question" id="questionText">
                    å•é¡Œæ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
                
                <div class="choices" id="choices">
                    <div class="choice" onclick="selectChoice(0)">é¸æŠè‚¢1</div>
                    <div class="choice" onclick="selectChoice(1)">é¸æŠè‚¢2</div>
                    <div class="choice" onclick="selectChoice(2)">é¸æŠè‚¢3</div>
                </div>
                
                <!-- ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ -->
                <div class="practice-controls" id="practiceControls" style="display: none;">
                    <button class="btn btn-secondary" onclick="skipQuestion()">
                        â­ï¸ ã“ã®å•é¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                    </button>
                </div>
                
                <!-- å›ç­”è€…è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="answer-log" id="answerLog">
                    <h4>ğŸ“Š å›ç­”çŠ¶æ³</h4>
                    <div id="answerList"></div>
                </div>
                
                <!-- ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã®è§£èª¬è¡¨ç¤º -->
                <div class="explanation" id="explanationArea" style="display: none;">
                    <h4>ğŸ’¡ è§£èª¬</h4>
                    <div id="explanationText"></div>
                </div>
            </div>

            <!-- çµæœç”»é¢ -->
            <div id="resultScreen" class="screen">
                <h2 id="resultTitle">ğŸ† æœ€çµ‚çµæœ</h2>
                <div class="results" id="results"></div>
                
                <!-- ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã®çµ±è¨ˆæƒ…å ± -->
                <div class="practice-stats" id="practiceStats" style="display: none;">
                    <h3>ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">æ­£ç­”ç‡</span>
                            <span class="stat-value" id="correctRate">0%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å¹³å‡å›ç­”æ™‚é–“</span>
                            <span class="stat-value" id="averageTime">0ç§’</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ç·å¾—ç‚¹</span>
                            <span class="stat-value" id="totalScore">0ç‚¹</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">é€£ç¶šæ­£è§£</span>
                            <span class="stat-value" id="maxStreak">0å•</span>
                        </div>
                    </div>
                </div>
                
                <!-- é–“é•ãˆãŸå•é¡Œã®å¾©ç¿’ -->
                <div class="review-section" id="reviewSection" style="display: none;">
                    <h3>ğŸ”„ é–“é•ãˆãŸå•é¡Œã®å¾©ç¿’</h3>
                    <div id="reviewQuestions"></div>
                    <div class="center">
                        <button class="btn btn-warning" onclick="startReviewMode()">
                            ğŸ“ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã§å†æŒ‘æˆ¦
                        </button>
                    </div>
                </div>
                
                <div class="center">
                    <button class="btn btn-primary" onclick="resetGame()">
                        ğŸ”„ ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤
                    </button>
                    <button class="btn btn-danger" onclick="showHome()">
                        ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </button>
                </div>
            </div>

            <!-- å•é¡Œä½œæˆç”»é¢ -->
            <div id="questionCreatorScreen" class="screen">
                <h2>âœï¸ ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œä½œæˆ</h2>
                <div class="question-form">
                    <div class="form-group">
                        <label>ğŸ“ ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select id="questionCategory">
                            <option value="general">ğŸ“š ä¸€èˆ¬å¸¸è­˜</option>
                            <option value="geography">ğŸŒ åœ°ç†</option>
                            <option value="history">ğŸ“œ æ­´å²</option>
                            <option value="science">ğŸ”¬ ç§‘å­¦</option>
                            <option value="sports">âš½ ã‚¹ãƒãƒ¼ãƒ„</option>
                            <option value="entertainment">ğŸ¬ ã‚¨ãƒ³ã‚¿ãƒ¡</option>
                            <option value="custom">âœï¸ ã‚«ã‚¹ã‚¿ãƒ </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>â“ å•é¡Œæ–‡</label>
                        <textarea id="newQuestion" placeholder="é­…åŠ›çš„ãªå•é¡Œæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ğŸ…°ï¸ é¸æŠè‚¢1</label>
                        <input type="text" id="choice1" placeholder="é¸æŠè‚¢1ã‚’å…¥åŠ›">
                    </div>
                    <div class="form-group">
                        <label>ğŸ…±ï¸ é¸æŠè‚¢2</label>
                        <input type="text" id="choice2" placeholder="é¸æŠè‚¢2ã‚’å…¥åŠ›">
                    </div>
                    <div class="form-group">
                        <label>ğŸ…²ï¸ é¸æŠè‚¢3</label>
                        <input type="text" id="choice3" placeholder="é¸æŠè‚¢3ã‚’å…¥åŠ›">
                    </div>
                    <div class="form-group">
                        <label>âœ… æ­£è§£ã®é¸æŠè‚¢ç•ªå·ï¼ˆ1-3ï¼‰</label>
                        <input type="number" id="correctAnswer" min="1" max="3" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>ğŸ’¡ è§£èª¬ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                        <textarea id="questionExplanation" placeholder="å•é¡Œã®è§£èª¬ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addQuestion()">
                        â• å•é¡Œã‚’è¿½åŠ 
                    </button>
                </div>
                
                <div class="question-list">
                    <h3>ğŸ“ ç™»éŒ²æ¸ˆã¿ã®å•é¡Œ</h3>
                    <div id="questionList"></div>
                </div>
                
                <div class="center">
                    <button class="btn btn-danger" onclick="showHome()">
                        â† æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
let gameState = {
    mode: 'local', // local, online, practice
    players: [],
    currentQuestion: 0,
    questions: [],
    timer: null,
    timeLeft: 15,
    scores: {},
    selectedCategories: [],
    currentAnswers: [],
    hasAnswered: false,
    onlineState: {
        ws: null,
        roomId: null,
        playerId: null,
        isHost: false,
        connected: false
    },
    practiceState: {
        selectedCategories: [],
        timeLimit: 15,
        questionCount: 10,
        questionOrder: 'random',
        showExplanation: true,
        showStatistics: true,
        reviewIncorrect: true,
        startTime: null,
        incorrectAnswers: [],
        answerTimes: [],
        streak: 0,
        maxStreak: 0,
        currentStreak: 0
    }
};

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å•é¡Œï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ï¼‰
const defaultQuestions = {
    general: [
        {
            question: "æ—¥æœ¬ã®é¦–éƒ½ã¯ã©ã“ã§ã™ã‹ï¼Ÿ",
            choices: ["å¤§é˜ª", "æ±äº¬", "äº¬éƒ½"],
            correct: 1,
            category: "general",
            explanation: "æ—¥æœ¬ã®é¦–éƒ½ã¯æ±äº¬ã§ã™ã€‚1868å¹´ã®æ˜æ²»ç¶­æ–°ä»¥é™ã€æ”¿æ²»ãƒ»çµŒæ¸ˆã®ä¸­å¿ƒåœ°ã¨ãªã‚Šã¾ã—ãŸã€‚"
        },
        {
            question: "æ—¥æœ¬ã®é€šè²¨å˜ä½ã¯ï¼Ÿ",
            choices: ["ã‚¦ã‚©ãƒ³", "å…ƒ", "å††"],
            correct: 2,
            category: "general",
            explanation: "æ—¥æœ¬ã®é€šè²¨å˜ä½ã¯å††ï¼ˆãˆã‚“ï¼‰ã§ã™ã€‚è¨˜å·ã¯Â¥ã§è¡¨ã•ã‚Œã¾ã™ã€‚"
        },
        {
            question: "æ—¥æœ¬ã®å›½èŠ±ã¯ï¼Ÿ",
            choices: ["æ¡œ", "èŠ", "æ¢…"],
            correct: 0,
            category: "general",
            explanation: "æ—¥æœ¬ã®å›½èŠ±ã¯æ¡œã§ã™ã€‚æ˜¥ã®è±¡å¾´ã¨ã—ã¦å¤ãã‹ã‚‰æ„›ã•ã‚Œã¦ã„ã¾ã™ã€‚"
        }
    ],
    geography: [
        {
            question: "å¯Œå£«å±±ã®é«˜ã•ã¯ï¼Ÿ",
            choices: ["3,776m", "3,676m", "3,876m"],
            correct: 0,
            category: "geography",
            explanation: "å¯Œå£«å±±ã®é«˜ã•ã¯3,776mã§ã€æ—¥æœ¬æœ€é«˜å³°ã®å±±ã§ã™ã€‚"
        },
        {
            question: "æ—¥æœ¬ã§ä¸€ç•ªå¤§ããªæ¹–ã¯ï¼Ÿ",
            choices: ["éœãƒ¶æµ¦", "çµç¶æ¹–", "æ´çˆºæ¹–"],
            correct: 1,
            category: "geography",
            explanation: "çµç¶æ¹–ã¯æ»‹è³€çœŒã«ã‚ã‚‹æ—¥æœ¬æœ€å¤§ã®æ¹–ã§ã™ã€‚é¢ç©ã¯ç´„670.3kmÂ²ã§ã™ã€‚"
        },
        {
            question: "æ—¥æœ¬ã§ä¸€ç•ªé•·ã„å·ã¯ï¼Ÿ",
            choices: ["åˆ©æ ¹å·", "ä¿¡æ¿ƒå·", "çŸ³ç‹©å·"],
            correct: 1,
            category: "geography",
            explanation: "ä¿¡æ¿ƒå·ã¯æ–°æ½ŸçœŒã‚’æµã‚Œã‚‹æ—¥æœ¬æœ€é•·ã®å·ã§ã€å…¨é•·367kmã§ã™ã€‚"
        }
    ],
    history: [
        {
            question: "éŒå€‰å¹•åºœã‚’é–‹ã„ãŸã®ã¯èª°ï¼Ÿ",
            choices: ["æºé ¼æœ", "è¶³åˆ©å°Šæ°", "å¾³å·å®¶åº·"],
            correct: 0,
            category: "history",
            explanation: "æºé ¼æœãŒ1192å¹´ã«éŒå€‰å¹•åºœã‚’é–‹ãã€æ—¥æœ¬åˆã®æ­¦å®¶æ”¿æ¨©ã‚’ç¢ºç«‹ã—ã¾ã—ãŸã€‚"
        },
        {
            question: "æ˜æ²»ç¶­æ–°ã¯ä½•å¹´ï¼Ÿ",
            choices: ["1868å¹´", "1858å¹´", "1878å¹´"],
            correct: 0,
            category: "history",
            explanation: "æ˜æ²»ç¶­æ–°ã¯1868å¹´ã«èµ·ã“ã‚Šã€æ±Ÿæˆ¸æ™‚ä»£ã‹ã‚‰æ˜æ²»æ™‚ä»£ã¸ã®è»¢æ›ç‚¹ã¨ãªã‚Šã¾ã—ãŸã€‚"
        },
        {
            question: "ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦ãŒçµ‚ã‚ã£ãŸå¹´ã¯ï¼Ÿ",
            choices: ["1944å¹´", "1945å¹´", "1946å¹´"],
            correct: 1,
            category: "history",
            explanation: "ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦ã¯1945å¹´ã«çµ‚çµã—ã¾ã—ãŸã€‚æ—¥æœ¬ã¯8æœˆ15æ—¥ã«çµ‚æˆ¦ã‚’è¿ãˆã¾ã—ãŸã€‚"
        }
    ],
    science: [
        {
            question: "æ°´ã®åŒ–å­¦å¼ã¯ï¼Ÿ",
            choices: ["CO2", "H2O", "O2"],
            correct: 1,
            category: "science",
            explanation: "æ°´ã®åŒ–å­¦å¼ã¯H2Oã§ã™ã€‚æ°´ç´ åŸå­2å€‹ã¨é…¸ç´ åŸå­1å€‹ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚"
        },
        {
            question: "å…‰ã®é€Ÿåº¦ã¯ç´„ï¼Ÿ",
            choices: ["30ä¸‡km/ç§’", "3ä¸‡km/ç§’", "300ä¸‡km/ç§’"],
            correct: 0,
            category: "science",
            explanation: "å…‰ã®é€Ÿåº¦ã¯ç´„30ä¸‡km/ç§’ï¼ˆæ­£ç¢ºã«ã¯299,792,458m/ç§’ï¼‰ã§ã™ã€‚"
        },
        {
            question: "åœ°çƒã‹ã‚‰å¤ªé™½ã¾ã§ã®è·é›¢ã¯ç´„ï¼Ÿ",
            choices: ["1å„„5000ä¸‡km", "1000ä¸‡km", "10å„„km"],
            correct: 0,
            category: "science",
            explanation: "åœ°çƒã‹ã‚‰å¤ªé™½ã¾ã§ã®å¹³å‡è·é›¢ã¯ç´„1å„„5000ä¸‡kmã§ã€ã“ã‚Œã‚’1å¤©æ–‡å˜ä½ï¼ˆAUï¼‰ã¨å‘¼ã³ã¾ã™ã€‚"
        }
    ],
    sports: [
        {
            question: "æ±äº¬ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯2020ã®é–‹å‚¬å¹´ã¯ï¼Ÿ",
            choices: ["2020å¹´", "2021å¹´", "2022å¹´"],
            correct: 1,
            category: "sports",
            explanation: "æ±äº¬ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯2020ã¯æ–°å‹ã‚³ãƒ­ãƒŠã‚¦ã‚¤ãƒ«ã‚¹ã®å½±éŸ¿ã§2021å¹´ã«å»¶æœŸé–‹å‚¬ã•ã‚Œã¾ã—ãŸã€‚"
        },
        {
            question: "ã‚µãƒƒã‚«ãƒ¼ã®ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚«ãƒƒãƒ—ã¯ä½•å¹´ã”ã¨ï¼Ÿ",
            choices: ["2å¹´", "3å¹´", "4å¹´"],
            correct: 2,
            category: "sports",
            explanation: "FIFAãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚«ãƒƒãƒ—ã¯4å¹´ã«ä¸€åº¦é–‹å‚¬ã•ã‚Œã‚‹ä¸–ç•Œæœ€å¤§ã®ã‚µãƒƒã‚«ãƒ¼å¤§ä¼šã§ã™ã€‚"
        },
        {
            question: "é‡çƒã§1ã‚¤ãƒ‹ãƒ³ã‚°ã«æŠ•æ‰‹ãŒæŠ•ã’ã‚‹æœ€å°‘çƒæ•°ã¯ï¼Ÿ",
            choices: ["3çƒ", "6çƒ", "9çƒ"],
            correct: 0,
            category: "sports",
            explanation: "3äººã®æ‰“è€…ã‚’3çƒã§ä¸‰æŒ¯ã«å–ã‚Œã°ã€1ã‚¤ãƒ‹ãƒ³ã‚°æœ€å°‘3çƒã§çµ‚ã‚ã‚Šã¾ã™ã€‚"
        }
    ],
    entertainment: [
        {
            question: "ã‚¸ãƒ–ãƒªä½œå“ã€Œåƒã¨åƒå°‹ã®ç¥éš ã—ã€ã®ç›£ç£ã¯ï¼Ÿ",
            choices: ["å®®å´é§¿", "é«˜ç•‘å‹²", "ç´°ç”°å®ˆ"],
            correct: 0,
            category: "entertainment",
            explanation: "ã€Œåƒã¨åƒå°‹ã®ç¥éš ã—ã€ã¯å®®å´é§¿ç›£ç£ã«ã‚ˆã‚‹2001å¹´ã®ä½œå“ã§ã€æ—¥æœ¬æ˜ ç”»å²ä¸Šæœ€é«˜ã®èˆˆè¡Œåå…¥ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚"
        },
        {
            question: "ã€Œé¬¼æ»…ã®åˆƒã€ã®ä¸»äººå…¬ã®åå‰ã¯ï¼Ÿ",
            choices: ["ç«ˆé–€ç‚­æ²»éƒ", "æˆ‘å¦»å–„é€¸", "å˜´å¹³ä¼Šä¹‹åŠ©"],
            correct: 0,
            category: "entertainment",
            explanation: "ç«ˆé–€ç‚­æ²»éƒï¼ˆã‹ã¾ã© ãŸã‚“ã˜ã‚ã†ï¼‰ãŒã€Œé¬¼æ»…ã®åˆƒã€ã®ä¸»äººå…¬ã§ã™ã€‚"
        },
        {
            question: "ãƒã‚±ãƒ¢ãƒ³ã®æœ€åˆã®å¾¡ä¸‰å®¶ã¯ï¼Ÿ",
            choices: ["ãƒ•ã‚·ã‚®ãƒ€ãƒãƒ»ãƒ’ãƒˆã‚«ã‚²ãƒ»ã‚¼ãƒ‹ã‚¬ãƒ¡", "ãƒã‚³ãƒªãƒ¼ã‚¿ãƒ»ãƒ’ãƒã‚¢ãƒ©ã‚·ãƒ»ãƒ¯ãƒ‹ãƒã‚³", "ã‚­ãƒ¢ãƒªãƒ»ã‚¢ãƒãƒ£ãƒ¢ãƒ»ãƒŸã‚ºã‚´ãƒ­ã‚¦"],
            correct: 0,
            category: "entertainment",
            explanation: "åˆä»£ãƒã‚±ãƒ¢ãƒ³ï¼ˆèµ¤ãƒ»ç·‘ï¼‰ã®å¾¡ä¸‰å®¶ã¯ãƒ•ã‚·ã‚®ãƒ€ãƒï¼ˆãã•ï¼‰ã€ãƒ’ãƒˆã‚«ã‚²ï¼ˆã»ã®ãŠï¼‰ã€ã‚¼ãƒ‹ã‚¬ãƒ¡ï¼ˆã¿ãšï¼‰ã§ã™ã€‚"
        }
    ]
};

// ã‚«ã‚¹ã‚¿ãƒ å•é¡Œç®¡ç†
let customQuestions = [];

// ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½
function startPracticeMode() {
    gameState.mode = 'practice';
    showScreen('practiceModeScreen');
}

function togglePracticeCategory(categoryKey) {
    const categoryItem = document.querySelector(`#practiceCategorySelection [data-category="${categoryKey}"]`);
    if (!categoryItem) return;
    
    const index = gameState.practiceState.selectedCategories.indexOf(categoryKey);
    if (index === -1) {
        gameState.practiceState.selectedCategories.push(categoryKey);
        categoryItem.classList.add('selected');
    } else {
        gameState.practiceState.selectedCategories.splice(index, 1);
        categoryItem.classList.remove('selected');
    }
}

function startPracticeGame() {
    if (gameState.practiceState.selectedCategories.length === 0) {
        alert('æœ€ä½1ã¤ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    // è¨­å®šã‚’å–å¾—
    gameState.practiceState.timeLimit = parseInt(document.getElementById('practiceTimeLimit').value);
    gameState.practiceState.questionCount = parseInt(document.getElementById('practiceQuestionCount').value);
    gameState.practiceState.questionOrder = document.getElementById('practiceQuestionOrder').value;
    gameState.practiceState.showExplanation = document.getElementById('showAnswerExplanation').checked;
    gameState.practiceState.showStatistics = document.getElementById('showStatistics').checked;
    gameState.practiceState.reviewIncorrect = document.getElementById('reviewIncorrect').checked;
    
    // ç·´ç¿’ç”¨ã®å•é¡Œã‚’æº–å‚™
    let questions = loadPracticeQuestions();
    
    if (questions.length === 0) {
        alert('é¸æŠã—ãŸã‚«ãƒ†ã‚´ãƒªã«å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // å•é¡Œæ•°ã®èª¿æ•´
    if (gameState.practiceState.questionCount > 0 && gameState.practiceState.questionCount < questions.length) {
        questions = questions.slice(0, gameState.practiceState.questionCount);
    }
    
    // å•é¡Œé †åºã®è¨­å®š
    if (gameState.practiceState.questionOrder === 'random') {
        questions = shuffleArray(questions);
    } else if (gameState.practiceState.questionOrder === 'category') {
        questions.sort((a, b) => a.category.localeCompare(b.category));
    }
    
    gameState.questions = questions;
    gameState.currentQuestion = 0;
    gameState.mode = 'practice';
    
    // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã®çŠ¶æ…‹åˆæœŸåŒ–
    gameState.practiceState.startTime = Date.now();
    gameState.practiceState.incorrectAnswers = [];
    gameState.practiceState.answerTimes = [];
    gameState.practiceState.currentStreak = 0;
    gameState.practiceState.maxStreak = 0;
    gameState.scores = { practice: 0 };
    
    showPracticeQuestion();
}

function loadPracticeQuestions() {
    const saved = localStorage.getItem('customQuestions');
    customQuestions = saved ? JSON.parse(saved) : [];
    
    let allQuestions = [];
    
    gameState.practiceState.selectedCategories.forEach(category => {
        if (defaultQuestions[category]) {
            allQuestions = allQuestions.concat(defaultQuestions[category]);
        }
        if (category === 'custom') {
            allQuestions = allQuestions.concat(customQuestions);
        }
    });
    
    return allQuestions;
}

function showPracticeQuestion() {
    if (gameState.currentQuestion >= gameState.questions.length) {
        showPracticeResults();
        return;
    }
    
    const question = gameState.questions[gameState.currentQuestion];
    gameState.hasAnswered = false;
    gameState.questionStartTime = Date.now();
    
    showScreen('quizScreen');
    
    // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã®UIæ›´æ–°
    document.getElementById('gameModeInfo').textContent = 'ğŸ¯ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ - ã˜ã£ãã‚Šè€ƒãˆã¦æ­£è§£ã‚’ç›®æŒ‡ãã†ï¼';
    document.getElementById('practiceControls').style.display = 'block';
    document.getElementById('answerLog').style.display = 'none';
    document.getElementById('explanationArea').style.display = 'none';
    
    document.getElementById('questionText').textContent = question.question;
    document.getElementById('questionNumber').textContent = `ç¬¬${gameState.currentQuestion + 1}å• / ${gameState.questions.length}å•`;
    
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = question.choices.map((choice, index) => `
        <div class="choice" onclick="selectPracticeChoice(${index})">${choice}</div>
    `).join('');
    
    // ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
    if (gameState.practiceState.timeLimit > 0) {
        gameState.timeLeft = gameState.practiceState.timeLimit;
        startPracticeTimer();
    } else {
        document.getElementById('timer').textContent = 'âˆ';
        gameState.timeLeft = -1;
    }
}

function startPracticeTimer() {
    if (gameState.timer) {
        clearInterval(gameState.timer);
        gameState.timer = null;
    }
    
    updateTimerDisplay();
    
    if (gameState.timeLeft > 0) {
        gameState.timer = setInterval(() => {
            gameState.timeLeft--;
            updateTimerDisplay();
            
            if (gameState.timeLeft <= 0) {
                clearInterval(gameState.timer);
                gameState.timer = null;
                handlePracticeTimeUp();
            }
        }, 1000);
    }
}

function selectPracticeChoice(index) {
    if (gameState.hasAnswered) return;
    
    gameState.hasAnswered = true;
    stopTimer();
    
    const answerTime = gameState.questionStartTime ? (Date.now() - gameState.questionStartTime) / 1000 : 0;
    gameState.practiceState.answerTimes.push(answerTime);
    
    const question = gameState.questions[gameState.currentQuestion];
    const isCorrect = index === question.correct;
    
    // é¸æŠè‚¢ã®è‰²ã‚’æ›´æ–°
    const choices = document.querySelectorAll('.choice');
    choices.forEach(choice => {
        choice.style.pointerEvents = 'none';
        choice.classList.add('disabled');
    });
    
    if (isCorrect) {
        choices[index].classList.add('correct');
        gameState.scores.practice += calculatePracticeScore(answerTime);
        gameState.practiceState.currentStreak++;
        gameState.practiceState.maxStreak = Math.max(gameState.practiceState.maxStreak, gameState.practiceState.currentStreak);
    } else {
        choices[index].classList.add('incorrect');
        choices[question.correct].classList.add('correct');
        gameState.practiceState.incorrectAnswers.push({
            question: question,
            userAnswer: index,
            correctAnswer: question.correct
        });
        gameState.practiceState.currentStreak = 0;
    }
    
    // è§£èª¬ã‚’è¡¨ç¤º
    if (gameState.practiceState.showExplanation && question.explanation) {
        showExplanation(question.explanation, isCorrect);
    }
    
    // ç·´ç¿’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°
    updatePracticeControls(isCorrect);
    
    setTimeout(() => {
        nextPracticeQuestion();
    }, gameState.practiceState.showExplanation ? 4000 : 2000);
}

function calculatePracticeScore(answerTime) {
    const baseScore = 100;
    const timeBonus = Math.max(0, (gameState.practiceState.timeLimit - answerTime) * 2);
    return Math.round(baseScore + timeBonus);
}

function showExplanation(explanationText, isCorrect) {
    const explanationArea = document.getElementById('explanationArea');
    const explanationTextDiv = document.getElementById('explanationText');
    
    explanationTextDiv.textContent = explanationText;
    explanationArea.style.display = 'block';
    
    // æ­£è§£/ä¸æ­£è§£ã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
    if (isCorrect) {
        explanationArea.style.borderLeftColor = 'var(--accent-success)';
    } else {
        explanationArea.style.borderLeftColor = 'var(--accent-danger)';
    }
}

function updatePracticeControls(isCorrect) {
    const practiceControls = document.getElementById('practiceControls');
    practiceControls.innerHTML = `
        <div style="text-align: center; margin: 1rem 0;">
            <span style="font-size: 1.2rem; font-weight: 500; color: ${isCorrect ? 'var(--accent-success)' : 'var(--accent-danger)'};">
                ${isCorrect ? 'âœ… æ­£è§£ï¼' : 'âŒ ä¸æ­£è§£'}
            </span>
        </div>
        <button class="btn btn-primary" onclick="nextPracticeQuestion()">
            â­ï¸ æ¬¡ã®å•é¡Œ
        </button>
        <button class="btn btn-secondary" onclick="skipQuestion()">
            â© ã‚¹ã‚­ãƒƒãƒ—
        </button>
    `;
}

function handlePracticeTimeUp() {
    if (gameState.hasAnswered) return;
    
    gameState.hasAnswered = true;
    const question = gameState.questions[gameState.currentQuestion];
    
    // æ™‚é–“åˆ‡ã‚Œã‚’è¨˜éŒ²
    gameState.practiceState.answerTimes.push(gameState.practiceState.timeLimit);
    gameState.practiceState.incorrectAnswers.push({
        question: question,
        userAnswer: -1, // -1ã¯æ™‚é–“åˆ‡ã‚Œã‚’è¡¨ã™
        correctAnswer: question.correct
    });
    gameState.practiceState.currentStreak = 0;
    
    const choices = document.querySelectorAll('.choice');
    choices.forEach(choice => {
        choice.style.pointerEvents = 'none';
        choice.classList.add('disabled');
    });
    choices[question.correct].classList.add('correct');
    
    if (gameState.practiceState.showExplanation && question.explanation) {
        showExplanation(question.explanation, false);
    }
    
    updatePracticeControls(false);
    
    setTimeout(() => {
        nextPracticeQuestion();
    }, gameState.practiceState.showExplanation ? 4000 : 2000);
}

function skipQuestion() {
    if (gameState.hasAnswered) {
        nextPracticeQuestion();
        return;
    }
    
    stopTimer();
    gameState.hasAnswered = true;
    
    const question = gameState.questions[gameState.currentQuestion];
    gameState.practiceState.answerTimes.push(0); // ã‚¹ã‚­ãƒƒãƒ—ã¯0ç§’ã¨ã—ã¦è¨˜éŒ²
    gameState.practiceState.currentStreak = 0;
    
    // æ­£è§£ã‚’è¡¨ç¤º
    const choices = document.querySelectorAll('.choice');
    choices.forEach(choice => {
        choice.style.pointerEvents = 'none';
        choice.classList.add('disabled');
    });
    choices[question.correct].classList.add('correct');
    
    if (gameState.practiceState.showExplanation && question.explanation) {
        showExplanation(question.explanation, false);
    }
    
    setTimeout(() => {
        nextPracticeQuestion();
    }, 2000);
}

function nextPracticeQuestion() {
    gameState.currentQuestion++;
    if (gameState.currentQuestion >= gameState.questions.length) {
        showPracticeResults();
    } else {
        showPracticeQuestion();
    }
}

function showPracticeResults() {
    showScreen('resultScreen');
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
    document.getElementById('resultTitle').textContent = 'ğŸ¯ ç·´ç¿’çµæœ';
    
    // é€šå¸¸ã®çµæœè¡¨ç¤ºã‚’éè¡¨ç¤º
    document.getElementById('results').style.display = 'none';
    
    // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
    if (gameState.practiceState.showStatistics) {
        showPracticeStatistics();
    }
    
    // å¾©ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    if (gameState.practiceState.reviewIncorrect && gameState.practiceState.incorrectAnswers.length > 0) {
        showReviewSection();
    }
}

function showPracticeStatistics() {
    const practiceStats = document.getElementById('practiceStats');
    practiceStats.style.display = 'block';
    
    const totalQuestions = gameState.questions.length;
    const correctAnswers = totalQuestions - gameState.practiceState.incorrectAnswers.length;
    const correctRate = Math.round((correctAnswers / totalQuestions) * 100);
    
    const totalTime = gameState.practiceState.answerTimes.reduce((sum, time) => sum + time, 0);
    const averageTime = Math.round(totalTime / totalQuestions * 10) / 10;
    
    document.getElementById('correctRate').textContent = `${correctRate}%`;
    document.getElementById('averageTime').textContent = `${averageTime}ç§’`;
    document.getElementById('totalScore').textContent = `${gameState.scores.practice}ç‚¹`;
    document.getElementById('maxStreak').textContent = `${gameState.practiceState.maxStreak}å•`;
}

function showReviewSection() {
    const reviewSection = document.getElementById('reviewSection');
    const reviewQuestions = document.getElementById('reviewQuestions');
    
    reviewSection.style.display = 'block';
    
    reviewQuestions.innerHTML = gameState.practiceState.incorrectAnswers.map((item, index) => {
        const userAnswerText = item.userAnswer === -1 ? 'æ™‚é–“åˆ‡ã‚Œ' : 
                              item.question.choices[item.userAnswer];
        
        return `
            <div class="review-question">
                <div class="review-question-text">
                    <strong>Q${index + 1}:</strong> ${item.question.question}
                </div>
                <div class="review-choices">
                    ${item.question.choices.map((choice, i) => `
                        <div class="review-choice ${
                            i === item.correctAnswer ? 'correct' : 
                            i === item.userAnswer ? 'incorrect' : 'neutral'
                        }">
                            ${choice} ${i === item.correctAnswer ? 'âœ“' : ''}
                            ${i === item.userAnswer && i !== item.correctAnswer ? 'âœ—' : ''}
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                    ã‚ãªãŸã®å›ç­”: ${userAnswerText} | æ­£è§£: ${item.question.choices[item.correctAnswer]}
                </div>
                ${item.question.explanation ? `
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--border-radius); font-size: 0.9rem;">
                        ğŸ’¡ ${item.question.explanation}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function startReviewMode() {
    if (gameState.practiceState.incorrectAnswers.length === 0) {
        alert('å¾©ç¿’ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // é–“é•ãˆãŸå•é¡Œã®ã¿ã§æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
    gameState.questions = gameState.practiceState.incorrectAnswers.map(item => item.question);
    gameState.currentQuestion = 0;
    gameState.practiceState.startTime = Date.now();
    gameState.practiceState.incorrectAnswers = [];
    gameState.practiceState.answerTimes = [];
    gameState.practiceState.currentStreak = 0;
    gameState.practiceState.maxStreak = 0;
    gameState.scores = { practice: 0 };
    
    showPracticeQuestion();
}

// WebSocketæ¥ç¶šç®¡ç†
function initWebSocket() {
    const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
    
    let wsUrl;
    if (isProduction) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        wsUrl = `${protocol}//${window.location.host}`;
    } else {
        wsUrl = 'ws://localhost:8080';
    }
    
    console.log('WebSocketæ¥ç¶šå…ˆ:', wsUrl);
    
    try {
        gameState.onlineState.ws = new WebSocket(wsUrl);
        
        gameState.onlineState.ws.onopen = () => {
            console.log('WebSocketæ¥ç¶šæˆåŠŸ');
            updateConnectionStatus(true);
        };
        
        gameState.onlineState.ws.onclose = () => {
            console.log('WebSocketæ¥ç¶šåˆ‡æ–­');
            updateConnectionStatus(false);
            setTimeout(() => {
                if (!gameState.onlineState.connected) {
                    initWebSocket();
                }
            }, 3000);
        };
        
        gameState.onlineState.ws.onmessage = (event) => {
            handleWebSocketMessage(JSON.parse(event.data));
        };
        
        gameState.onlineState.ws.onerror = (error) => {
            console.error('WebSocketã‚¨ãƒ©ãƒ¼:', error);
            updateConnectionStatus(false);
        };
    } catch (error) {
        console.error('WebSocketæ¥ç¶šå¤±æ•—:', error);
        updateConnectionStatus(false);
    }
}

function handleWebSocketMessage(data) {
    console.log('å—ä¿¡:', data);
    
    switch(data.type) {
        case 'roomCreated':
            gameState.onlineState.roomId = data.roomId;
            gameState.onlineState.playerId = data.playerId;
            gameState.onlineState.isHost = true;
            document.getElementById('roomIdDisplay').innerHTML = `
                <div class="room-info">ğŸ›ï¸ ãƒ«ãƒ¼ãƒ ID: ${data.roomId}</div>
            `;
            showScreen('onlineWaitingScreen');
            updateOnlinePlayerList(data.players);
            document.getElementById('startOnlineGameBtn').style.display = 'block';
            break;
            
        case 'joinedRoom':
            gameState.onlineState.roomId = data.roomId;
            gameState.onlineState.playerId = data.playerId;
            gameState.onlineState.isHost = false;
            document.getElementById('roomIdDisplay').innerHTML = `
                <div class="room-info">ğŸ›ï¸ ãƒ«ãƒ¼ãƒ ID: ${data.roomId}</div>
            `;
            showScreen('onlineWaitingScreen');
            updateOnlinePlayerList(data.players);
            document.getElementById('startOnlineGameBtn').style.display = 'none';
            break;
            
        case 'playerJoined':
        case 'playerLeft':
        case 'playerReady':
        case 'playerUpdate':
            updateOnlinePlayerList(data.players);
            if (data.type === 'playerLeft' && gameState.onlineState.isHost) {
                document.getElementById('startOnlineGameBtn').style.display = 'block';
            }
            break;
            
        case 'newHost':
            if (data.hostId === gameState.onlineState.playerId) {
                gameState.onlineState.isHost = true;
                document.getElementById('startOnlineGameBtn').style.display = 'block';
            }
            break;
            
        case 'gameStart':
            startOnlineQuiz(data.questions);
            break;
            
        case 'countdown':
            showCountdown(data.count, data.questionNumber, data.totalQuestions);
            break;
            
        case 'nextQuestionCountdown':
            showNextQuestionCountdown(data.count, data.nextQuestionNumber, data.totalQuestions);
            break;
            
        case 'newQuestion':
            showOnlineQuestion(data);
            break;
            
        case 'timerUpdate':
            updateOnlineTimer(data.timeLeft);
            break;
            
        case 'answerReceived':
            handleOnlineAnswerReceived(data);
            break;
            
        case 'questionEnd':
            handleOnlineQuestionEnd(data);
            break;
            
        case 'nextQuestion':
            setTimeout(() => {
                console.log('æ¬¡ã®å•é¡Œã‚’å¾…æ©Ÿä¸­...');
            }, 1000);
            break;
            
        case 'gameEnd':
            showOnlineResults(data.finalScores);
            break;
            
        case 'error':
            alert(data.message);
            break;
            
        default:
            console.log('æœªå‡¦ç†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—:', data.type);
    }
}

// ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
function showCountdown(count, questionNumber, totalQuestions) {
    console.log(`ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º: ${count}, å•é¡Œ${questionNumber}/${totalQuestions}`);
    
    showScreen('countdownScreen');
    
    const countdownNumber = document.getElementById('countdownNumber');
    const countdownQuestionInfo = document.getElementById('countdownQuestionInfo');
    
    if (countdownNumber) {
        countdownNumber.textContent = count;
        countdownNumber.style.animation = 'none';
        setTimeout(() => {
            countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
        }, 10);
    }
    
    if (countdownQuestionInfo) {
        countdownQuestionInfo.textContent = `ç¬¬${questionNumber}å• / ${totalQuestions}å•`;
    }
}

// æ¥ç¶šçŠ¶æ…‹æ›´æ–°
function updateConnectionStatus(connected) {
    gameState.onlineState.connected = connected;
    const statusDiv = document.getElementById('connectionStatus');
    if (statusDiv) {
        statusDiv.textContent = connected ? 'âœ… ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'âŒ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
        statusDiv.className = connected ? 'connection-status connected' : 'connection-status disconnected';
        statusDiv.style.display = 'block';
    }
}

// ç”»é¢ç®¡ç†
function showScreen(screenId) {
    if (screenId !== 'quizScreen' || gameState.mode === 'local') {
        stopTimer();
    }
    
    const screens = document.querySelectorAll('.screen');
    screens.forEach(screen => screen.classList.remove('active'));
    
    const targetScreen = document.getElementById(screenId);
    if (targetScreen) {
        targetScreen.classList.add('active');
    }
}

function showHome() {
    gameState.players = [];
    gameState.scores = {};
    gameState.currentQuestion = 0;
    gameState.selectedCategories = [];
    gameState.practiceState.selectedCategories = [];
    stopTimer();
    showScreen('homeScreen');
    if (gameState.onlineState.ws) {
        gameState.onlineState.ws.close();
    }
}

// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½
function startLocalGame() {
    gameState.mode = 'local';
    showScreen('playerScreen');
}

function showOnlineMenu() {
    gameState.mode = 'online';
    showScreen('onlineMenuScreen');
    initWebSocket();
}

function showQuestionCreator() {
    showScreen('questionCreatorScreen');
    updateQuestionList();
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
function addPlayer() {
    const input = document.getElementById('playerName');
    const playerName = input.value.trim();
    
    if (!playerName) {
        alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    if (gameState.players.some(player => player.name === playerName)) {
        alert('åŒã˜åå‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™');
        return;
    }
    
    if (gameState.players.length >= 6) {
        alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æœ€å¤§6äººã¾ã§ã§ã™');
        return;
    }
    
    const player = {
        id: Date.now(),
        name: playerName
    };
    
    gameState.players.push(player);
    gameState.scores[player.id] = 0;
    
    input.value = '';
    updatePlayerList();
    
    const startBtn = document.getElementById('startBtn');
    if (gameState.players.length >= 2 && startBtn) {
        startBtn.style.display = 'block';
    }
}

function updatePlayerList() {
    const playerList = document.getElementById('playerList');
    if (!playerList) return;
    
    playerList.innerHTML = gameState.players.map(player => `
        <div class="player-item">
            <span>ğŸ‘¤ ${player.name}</span>
            <button class="btn btn-danger" onclick="removePlayer(${player.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
        </div>
    `).join('');
}

function removePlayer(playerId) {
    gameState.players = gameState.players.filter(player => player.id !== playerId);
    delete gameState.scores[playerId];
    updatePlayerList();
    
    const startBtn = document.getElementById('startBtn');
    if (gameState.players.length < 2 && startBtn) {
        startBtn.style.display = 'none';
    }
}

// ã‚«ãƒ†ã‚´ãƒªé¸æŠ
function showCategorySelection() {
    if (gameState.players.length < 2) {
        alert('æœ€ä½2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¿…è¦ã§ã™');
        return;
    }
    showScreen('categoryScreen');
}

function showPlayerRegistration() {
    showScreen('playerScreen');
}

function toggleCategory(categoryKey) {
    const categoryItem = document.querySelector(`#categorySelection [data-category="${categoryKey}"]`);
    if (!categoryItem) return;
    
    const index = gameState.selectedCategories.indexOf(categoryKey);
    if (index === -1) {
        gameState.selectedCategories.push(categoryKey);
        categoryItem.classList.add('selected');
    } else {
        gameState.selectedCategories.splice(index, 1);
        categoryItem.classList.remove('selected');
    }
}

function startGameWithCategories() {
    if (gameState.selectedCategories.length === 0) {
        alert('æœ€ä½1ã¤ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    let questions = loadQuestions();
    
    if (questions.length < 6) {
        alert('é¸æŠã—ãŸã‚«ãƒ†ã‚´ãƒªã®å•é¡ŒãŒå°‘ãªã™ãã¾ã™ï¼ˆæœ€ä½6å•å¿…è¦ï¼‰');
        return;
    }
    
    gameState.questions = shuffleArray(questions).slice(0, 6);
    gameState.currentQuestion = 0;
    gameState.mode = 'local';
    
    gameState.players.forEach(player => {
        gameState.scores[player.id] = 0;
    });
    
    showQuestion();
}

// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å•é¡Œã‚’èª­ã¿è¾¼ã‚€
function loadQuestions() {
    const saved = localStorage.getItem('customQuestions');
    customQuestions = saved ? JSON.parse(saved) : [];
    
    let allQuestions = [];
    
    gameState.selectedCategories.forEach(category => {
        if (defaultQuestions[category]) {
            allQuestions = allQuestions.concat(defaultQuestions[category]);
        }
        if (category === 'custom') {
            allQuestions = allQuestions.concat(customQuestions);
        }
    });
    
    return allQuestions;
}

// é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«
function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}

// å•é¡Œè¡¨ç¤ºãƒ»ç®¡ç†
function showQuestion() {
    if (gameState.mode === 'local') {
        stopTimer();
    }
    
    if (gameState.currentQuestion >= gameState.questions.length) {
        showResults();
        return;
    }
    
    const question = gameState.questions[gameState.currentQuestion];
    gameState.currentAnswers = [];
    gameState.hasAnswered = false;
    
    showScreen('quizScreen');
    
    // UIè¦ç´ ã‚’é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
    document.getElementById('gameModeInfo').textContent = 'âš¡ æ­£è§£è€…å…¨å“¡ã«ãƒã‚¤ãƒ³ãƒˆï¼æ—©æŠ¼ã—ã§é«˜å¾—ç‚¹ã‚’ç‹™ãˆï¼';
    document.getElementById('practiceControls').style.display = 'none';
    document.getElementById('answerLog').style.display = 'block';
    document.getElementById('explanationArea').style.display = 'none';
    
    document.getElementById('questionText').textContent = question.question;
    document.getElementById('questionNumber').textContent = `ç¬¬${gameState.currentQuestion + 1}å• / ${gameState.questions.length}å•`;
    
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = question.choices.map((choice, index) => `
        <div class="choice" onclick="selectChoice(${index})">${choice}</div>
    `).join('');
    
    document.getElementById('answerList').innerHTML = '';
    
    if (gameState.mode === 'local') {
        setTimeout(() => {
            startTimer();
        }, 100);
    }
}

// ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
function startTimer() {
    if (gameState.mode === 'online') {
        return;
    }
    
    if (gameState.timer) {
        clearInterval(gameState.timer);
        gameState.timer = null;
    }
    
    const timerElement = document.getElementById('timer');
    if (!timerElement) return;
    
    gameState.timeLeft = 15;
    updateTimerDisplay();
    
    gameState.timer = setInterval(() => {
        gameState.timeLeft--;
        updateTimerDisplay();
        
        if (gameState.timeLeft <= 0) {
            clearInterval(gameState.timer);
            gameState.timer = null;
            if (gameState.mode === 'local') {
                handleTimeUp();
            }
        }
    }, 1000);
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('timer');
    if (timerElement) {
        timerElement.textContent = gameState.timeLeft === -1 ? 'âˆ' : gameState.timeLeft;
    }
}

function handleTimeUp() {
    if (gameState.mode === 'online' || gameState.mode === 'practice') {
        return;
    }
    
    const choices = document.querySelectorAll('.choice');
    choices.forEach(choice => {
        choice.style.pointerEvents = 'none';
        choice.classList.add('disabled');
    });
    
    const question = gameState.questions[gameState.currentQuestion];
    choices[question.correct].classList.add('correct');
    
    setTimeout(() => {
        nextQuestion();
    }, 2000);
}

function stopTimer() {
    if (gameState.timer) {
        clearInterval(gameState.timer);
        gameState.timer = null;
    }
}

// å›ç­”å‡¦ç†
function selectChoice(index) {
    if (gameState.mode === 'local') {
        selectChoiceLocal(index);
    } else if (gameState.mode === 'online') {
        selectChoiceOnline(index);
    } else if (gameState.mode === 'practice') {
        selectPracticeChoice(index);
    }
}

function selectChoiceLocal(index) {
    if (gameState.players.length === 1) {
        processAnswer(gameState.players[0].name, index);
    } else {
        showPlayerSelectionDialog(index);
    }
}

function selectChoiceOnline(index) {
    if (gameState.hasAnswered) {
        console.log('æ—¢ã«å›ç­”æ¸ˆã¿ã§ã™');
        return;
    }
    
    console.log(`é¸æŠè‚¢${index}ã‚’é¸æŠã—ã¾ã—ãŸ`);
    gameState.hasAnswered = true;
    
    const choices = document.querySelectorAll('.choice');
    choices.forEach((choice, i) => {
        if (i === index) {
            choice.classList.add('selected');
        }
        choice.style.pointerEvents = 'none';
        choice.classList.add('disabled');
    });
    
    if (gameState.onlineState.ws && gameState.onlineState.ws.readyState === WebSocket.OPEN) {
        const message = {
            type: 'selectAnswer',
            roomId: gameState.onlineState.roomId,
            playerId: gameState.onlineState.playerId,
            answerIndex: index,
            timeLeft: gameState.timeLeft || 15
        };
        
        console.log('å›ç­”é€ä¿¡:', message);
        gameState.onlineState.ws.send(JSON.stringify(message));
    } else {
        console.error('WebSocketæ¥ç¶šãŒç„¡åŠ¹ã§ã™');
    }
}

function showPlayerSelectionDialog(choiceIndex) {
    const availablePlayers = gameState.players.filter(player => 
        !gameState.currentAnswers.some(answer => answer.player === player.name)
    );
    
    if (availablePlayers.length === 0) {
        alert('å…¨å“¡ãŒå›ç­”æ¸ˆã¿ã§ã™');
        return;
    }
    
    const playerList = availablePlayers.map(player => 
        `<button class="btn btn-primary" onclick="processAnswer('${player.name}', ${choiceIndex}); closePlayerDialog()">${player.name}</button>`
    ).join('');
    
    const dialog = document.createElement('div');
    dialog.id = 'playerDialog';
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 14, 39, 0.9);
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    
    dialog.innerHTML = `
        <div style="
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-heavy);
        ">
            <h3 style="color: var(--text-primary); margin-bottom: 1.5rem;">
                ğŸ‘¤ ã©ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå›ç­”ã—ã¾ã™ã‹ï¼Ÿ
            </h3>
            <div style="margin-bottom: 1.5rem;">
                ${playerList}
            </div>
            <button class="btn btn-danger" onclick="closePlayerDialog()">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    `;
    
    document.body.appendChild(dialog);
}

function closePlayerDialog() {
    const dialog = document.getElementById('playerDialog');
    if (dialog) {
        dialog.remove();
    }
}

function processAnswer(playerName, choiceIndex) {
    if (gameState.currentAnswers.some(answer => answer.player === playerName)) {
        alert('æ—¢ã«å›ç­”æ¸ˆã¿ã§ã™');
        return;
    }
    
    const question = gameState.questions[gameState.currentQuestion];
    const isCorrect = choiceIndex === question.correct;
    
    const answerData = {
        player: playerName,
        answer: choiceIndex,
        correct: isCorrect,
        timeLeft: gameState.timeLeft,
        order: gameState.currentAnswers.length + 1
    };
    
    gameState.currentAnswers.push(answerData);
    
    if (isCorrect) {
        const points = getPointsByOrder(answerData.order);
        const player = gameState.players.find(p => p.name === playerName);
        if (player) {
            gameState.scores[player.id] += points;
        }
    }
    
    const choices = document.querySelectorAll('.choice');
    if (isCorrect) {
        choices[choiceIndex].classList.add('correct');
    } else {
        choices[choiceIndex].classList.add('incorrect');
        choices[question.correct].classList.add('correct');
    }
    
    updateAnswerLog();
    
    if (gameState.currentAnswers.length >= gameState.players.length) {
        stopTimer();
        setTimeout(() => {
            nextQuestion();
        }, 2000);
    }
}

function updateAnswerLog() {
    const answerList = document.getElementById('answerList');
    if (!answerList) return;
    
    answerList.innerHTML = gameState.currentAnswers.map(answer => `
        <div class="answer-item ${answer.correct ? 'correct' : 'incorrect'}">
            <div>
                <span class="answer-order">${answer.order}ä½</span>
                <span>ğŸ‘¤ ${answer.player}</span>
            </div>
            <div>
                <span class="answer-points">${answer.correct ? getPointsByOrder(answer.order) : 0}pt</span>
            </div>
        </div>
    `).join('');
}

function getPointsByOrder(order) {
    switch(order) {
        case 1: return 100;
        case 2: return 80;
        case 3: return 60;
        default: return 40;
    }
}

function nextQuestion() {
    gameState.currentQuestion++;
    if (gameState.currentQuestion >= gameState.questions.length) {
        showResults();
    } else {
        showQuestion();
    }
}

// çµæœè¡¨ç¤º
function showResults() {
    stopTimer();
    showScreen('resultScreen');
    
    // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã®å ´åˆã®çµæœè¡¨ç¤º
    if (gameState.mode !== 'practice') {
        document.getElementById('resultTitle').textContent = 'ğŸ† æœ€çµ‚çµæœ';
        document.getElementById('results').style.display = 'block';
        document.getElementById('practiceStats').style.display = 'none';
        document.getElementById('reviewSection').style.display = 'none';
        
        if (gameState.mode === 'local') {
            const sortedPlayers = gameState.players.sort((a, b) => 
                gameState.scores[b.id] - gameState.scores[a.id]
            );
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = sortedPlayers.map((player, index) => `
                <div class="rank-item rank-${Math.min(index + 1, 3)}">
                    <div>
                        <span class="rank-number">${index + 1}</span>
                        <span>ğŸ‘¤ ${player.name}</span>
                    </div>
                    <div>ğŸ† ${gameState.scores[player.id]}ãƒã‚¤ãƒ³ãƒˆ</div>
                </div>
            `).join('');
        }
    }
}

function resetGame() {
    gameState.players = [];
    gameState.scores = {};
    gameState.currentQuestion = 0;
    gameState.selectedCategories = [];
    gameState.practiceState.selectedCategories = [];
    gameState.hasAnswered = false;
    stopTimer();
    
    if (gameState.mode === 'practice') {
        showScreen('practiceModeScreen');
    } else {
        showScreen('playerScreen');
    }
}

// å•é¡Œä½œæˆæ©Ÿèƒ½
function addQuestion() {
    const category = document.getElementById('questionCategory').value;
    const questionText = document.getElementById('newQuestion').value.trim();
    const choice1 = document.getElementById('choice1').value.trim();
    const choice2 = document.getElementById('choice2').value.trim();
    const choice3 = document.getElementById('choice3').value.trim();
    const correctAnswer = parseInt(document.getElementById('correctAnswer').value) - 1;
    const explanation = document.getElementById('questionExplanation').value.trim();
    
    if (!questionText || !choice1 || !choice2 || !choice3) {
        alert('å•é¡Œæ–‡ã¨é¸æŠè‚¢ã¯ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    if (correctAnswer < 0 || correctAnswer > 2) {
        alert('æ­£è§£ã®é¸æŠè‚¢ç•ªå·ã¯1-3ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const newQuestion = {
        question: questionText,
        choices: [choice1, choice2, choice3],
        correct: correctAnswer,
        category: category,
        explanation: explanation || null
    };
    
    const saved = localStorage.getItem('customQuestions');
    customQuestions = saved ? JSON.parse(saved) : [];
    customQuestions.push(newQuestion);
    localStorage.setItem('customQuestions', JSON.stringify(customQuestions));
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
    document.getElementById('newQuestion').value = '';
    document.getElementById('choice1').value = '';
    document.getElementById('choice2').value = '';
    document.getElementById('choice3').value = '';
    document.getElementById('correctAnswer').value = '';
    document.getElementById('questionExplanation').value = '';
    
    updateQuestionList();
    alert('âœ… å•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
}

function updateQuestionList() {
    const saved = localStorage.getItem('customQuestions');
    customQuestions = saved ? JSON.parse(saved) : [];
    
    const questionList = document.getElementById('questionList');
    if (!questionList) return;
    
    questionList.innerHTML = customQuestions.map((question, index) => `
        <div class="question-item">
            <strong>â“ Q${index + 1}:</strong> ${question.question}<br>
            <small>ğŸ“ ã‚«ãƒ†ã‚´ãƒª: ${getCategoryName(question.category)}</small><br>
            <small>ğŸ“ é¸æŠè‚¢: ${question.choices.join(', ')}</small><br>
            <small>âœ… æ­£è§£: ${question.choices[question.correct]}</small>
            ${question.explanation ? `<br><small>ğŸ’¡ è§£èª¬: ${question.explanation}</small>` : ''}
            <button class="btn btn-danger" onclick="removeQuestion(${index})" style="margin-top: 1rem;">
                ğŸ—‘ï¸ å‰Šé™¤
            </button>
        </div>
    `).join('');
}

function getCategoryName(category) {
    const names = {
        general: 'ğŸ“š ä¸€èˆ¬å¸¸è­˜',
        geography: 'ğŸŒ åœ°ç†',
        history: 'ğŸ“œ æ­´å²',
        science: 'ğŸ”¬ ç§‘å­¦',
        sports: 'âš½ ã‚¹ãƒãƒ¼ãƒ„',
        entertainment: 'ğŸ¬ ã‚¨ãƒ³ã‚¿ãƒ¡',
        custom: 'âœï¸ ã‚«ã‚¹ã‚¿ãƒ '
    };
    return names[category] || category;
}

function removeQuestion(index) {
    if (confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        const saved = localStorage.getItem('customQuestions');
        customQuestions = saved ? JSON.parse(saved) : [];
        customQuestions.splice(index, 1);
        localStorage.setItem('customQuestions', JSON.stringify(customQuestions));
        updateQuestionList();
    }
}

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½
function createRoom() {
    const playerName = document.getElementById('onlinePlayerName').value.trim();
    if (!playerName) {
        alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    if (!gameState.onlineState.ws || gameState.onlineState.ws.readyState !== WebSocket.OPEN) {
        alert('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    gameState.onlineState.ws.send(JSON.stringify({
        type: 'createRoom',
        playerName: playerName
    }));
}

function showJoinRoom() {
    showScreen('joinRoomScreen');
}

function joinRoom() {
    const playerName = document.getElementById('onlinePlayerName').value.trim();
    const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
    
    if (!playerName) {
        alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    if (!roomId) {
        alert('ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    if (!gameState.onlineState.ws || gameState.onlineState.ws.readyState !== WebSocket.OPEN) {
        alert('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    gameState.onlineState.ws.send(JSON.stringify({
        type: 'joinRoom',
        playerName: playerName,
        roomId: roomId
    }));
}

function togglePlayerReady() {
    if (!gameState.onlineState.playerId || !gameState.onlineState.ws || gameState.onlineState.ws.readyState !== WebSocket.OPEN) {
        console.error('WebSocketæ¥ç¶šãŒç„¡åŠ¹ã§ã™');
        return;
    }
    
    const message = {
        type: 'toggleReady',
        playerId: gameState.onlineState.playerId,
        roomId: gameState.onlineState.roomId
    };
    
    console.log('æº–å‚™çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆé€ä¿¡:', message);
    gameState.onlineState.ws.send(JSON.stringify(message));
}

function startOnlineGame() {
    if (!gameState.onlineState.isHost) {
        alert('ãƒ›ã‚¹ãƒˆã®ã¿ãŒã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™');
        return;
    }
    
    if (!gameState.onlineState.roomId || !gameState.onlineState.playerId) {
        alert('ãƒ«ãƒ¼ãƒ æƒ…å ±ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    showCategorySelectionDialog();
}

function showCategorySelectionDialog() {
    const dialog = document.createElement('div');
    dialog.id = 'categoryDialog';
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 14, 39, 0.9);
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    
    const categories = [
        { key: 'general', name: 'ğŸ“š ä¸€èˆ¬å¸¸è­˜' },
        { key: 'geography', name: 'ğŸŒ åœ°ç†' },
        { key: 'history', name: 'ğŸ“œ æ­´å²' },
        { key: 'science', name: 'ğŸ”¬ ç§‘å­¦' },
        { key: 'sports', name: 'âš½ ã‚¹ãƒãƒ¼ãƒ„' },
        { key: 'entertainment', name: 'ğŸ¬ ã‚¨ãƒ³ã‚¿ãƒ¡' }
    ];
    
    const categoryButtons = categories.map(cat => 
        `<button id="category-${cat.key}" class="category-btn" data-category="${cat.key}" 
                 style="
                    padding: 1rem 1.5rem;
                    margin: 0.5rem;
                    border: 2px solid var(--border-medium);
                    border-radius: var(--border-radius);
                    background: var(--bg-secondary);
                    color: var(--text-primary);
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 1rem;
                    transition: var(--transition);
                    position: relative;
                    min-width: 140px;
                    text-align: center;
                 ">${cat.name}</button>`
    ).join('');
    
    dialog.innerHTML = `
        <div style="
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow-heavy);
        ">
            <h3 style="color: var(--text-primary); margin-bottom: 1.5rem; font-size: 1.5rem;">
                ğŸ“š å•é¡Œã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                ${categoryButtons}
            </div>
            <div style="margin-bottom: 1.5rem;">
                <button id="selectAllBtn" class="btn btn-success">âœ… å…¨ã¦é¸æŠ</button>
                <button id="clearAllBtn" class="btn btn-secondary">âŒ å…¨ã¦è§£é™¤</button>
            </div>
            <div>
                <button id="startGameBtn" class="btn btn-primary">ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                <button id="cancelBtn" class="btn btn-danger">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    
    categories.forEach(cat => {
        const button = document.getElementById(`category-${cat.key}`);
        if (button) {
            button.addEventListener('click', function() {
                toggleDialogCategoryById(cat.key);
            });
        }
    });
    
    document.getElementById('selectAllBtn').addEventListener('click', selectAllCategories);
    document.getElementById('clearAllBtn').addEventListener('click', clearAllCategories);
    document.getElementById('startGameBtn').addEventListener('click', startGameWithSelectedCategories);
    document.getElementById('cancelBtn').addEventListener('click', closeCategoryDialog);
    
    setTimeout(() => {
        selectAllCategories();
    }, 100);
}

let selectedOnlineCategories = [];

function toggleDialogCategoryById(category) {
    const button = document.getElementById(`category-${category}`);
    if (!button) return;
    
    const index = selectedOnlineCategories.indexOf(category);
    
    const categories = {
        'general': 'ğŸ“š ä¸€èˆ¬å¸¸è­˜',
        'geography': 'ğŸŒ åœ°ç†', 
        'history': 'ğŸ“œ æ­´å²',
        'science': 'ğŸ”¬ ç§‘å­¦',
        'sports': 'âš½ ã‚¹ãƒãƒ¼ãƒ„',
        'entertainment': 'ğŸ¬ ã‚¨ãƒ³ã‚¿ãƒ¡'
    };
    
    if (index === -1) {
        selectedOnlineCategories.push(category);
        button.style.background = 'var(--accent-primary)';
        button.style.color = 'var(--text-light)';
        button.style.borderColor = 'var(--accent-primary)';
        button.innerHTML = `âœ“ ${categories[category]}`;
    } else {
        selectedOnlineCategories.splice(index, 1);
        button.style.background = 'var(--bg-secondary)';
        button.style.color = 'var(--text-primary)';
        button.style.borderColor = 'var(--border-medium)';
        button.innerHTML = categories[category];
    }
}

function selectAllCategories() {
    selectedOnlineCategories = ['general', 'geography', 'history', 'science', 'sports', 'entertainment'];
    
    const categories = {
        'general': 'ğŸ“š ä¸€èˆ¬å¸¸è­˜',
        'geography': 'ğŸŒ åœ°ç†',
        'history': 'ğŸ“œ æ­´å²',
        'science': 'ğŸ”¬ ç§‘å­¦',
        'sports': 'âš½ ã‚¹ãƒãƒ¼ãƒ„',
        'entertainment': 'ğŸ¬ ã‚¨ãƒ³ã‚¿ãƒ¡'
    };
    
    selectedOnlineCategories.forEach(category => {
        const button = document.getElementById(`category-${category}`);
        if (button) {
            button.style.background = 'var(--accent-primary)';
            button.style.color = 'var(--text-light)';
            button.style.borderColor = 'var(--accent-primary)';
            button.innerHTML = `âœ“ ${categories[category]}`;
        }
    });
}

function clearAllCategories() {
    const categories = {
        'general': 'ğŸ“š ä¸€èˆ¬å¸¸è­˜',
        'geography': 'ğŸŒ åœ°ç†',
        'history': 'ğŸ“œ æ­´å²',
        'science': 'ğŸ”¬ ç§‘å­¦',
        'sports': 'âš½ ã‚¹ãƒãƒ¼ãƒ„',
        'entertainment': 'ğŸ¬ ã‚¨ãƒ³ã‚¿ãƒ¡'
    };
    
    const currentSelected = [...selectedOnlineCategories];
    selectedOnlineCategories = [];
    
    currentSelected.forEach(category => {
        const button = document.getElementById(`category-${category}`);
        if (button) {
            button.style.background = 'var(--bg-secondary)';
            button.style.color = 'var(--text-primary)';
            button.style.borderColor = 'var(--border-medium)';
            button.innerHTML = categories[category];
        }
    });
}

function startGameWithSelectedCategories() {
    if (selectedOnlineCategories.length === 0) {
        alert('æœ€ä½1ã¤ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    closeCategoryDialog();
    
    const saved = localStorage.getItem('customQuestions');
    const customQuestions = saved ? JSON.parse(saved) : [];
    
    gameState.onlineState.ws.send(JSON.stringify({
        type: 'startGame',
        roomId: gameState.onlineState.roomId,
        playerId: gameState.onlineState.playerId,
        categories: selectedOnlineCategories,
        questions: customQuestions
    }));
}

function closeCategoryDialog() {
    const dialog = document.getElementById('categoryDialog');
    if (dialog) {
        dialog.remove();
    }
    selectedOnlineCategories = [];
}

function updateOnlinePlayerList(players) {
    const playerListDiv = document.getElementById('onlinePlayerList');
    if (!playerListDiv) return;
    
    playerListDiv.innerHTML = players.map(player => {
        let labels = '';
        if (player.id === gameState.onlineState.playerId) {
            labels += '<span class="you-label">ã‚ãªãŸ</span>';
        }
        if (player.isHost) {
            labels += '<span class="host-label">ãƒ›ã‚¹ãƒˆ</span>';
        }
        
        return `
            <div class="player-item ${player.ready ? 'ready' : ''}">
                <span>ğŸ‘¤ ${player.name} ${labels}</span>
                <span class="ready-status">${player.ready ? 'âœ… æº–å‚™å®Œäº†' : 'â³ å¾…æ©Ÿä¸­'}</span>
            </div>
        `;
    }).join('');
}

function startOnlineQuiz(questions) {
    gameState.questions = questions;
    gameState.currentQuestion = 0;
    gameState.mode = 'online';
    gameState.scores = {};
}

function showOnlineQuestion(data) {
    gameState.currentQuestion = data.questionNumber - 1;
    gameState.currentAnswers = [];
    gameState.hasAnswered = false;
    
    if (data.timeLeft !== undefined) {
        gameState.timeLeft = data.timeLeft;
    } else {
        gameState.timeLeft = 15;
    }
    
    showScreen('quizScreen');
    
    if (!gameState.questions[gameState.currentQuestion]) {
        gameState.questions[gameState.currentQuestion] = data.question;
    }
    
    document.getElementById('questionText').textContent = data.question.question;
    document.getElementById('questionNumber').textContent = `ç¬¬${data.questionNumber}å• / ${data.totalQuestions}å•`;
    
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = data.question.choices.map((choice, index) => `
        <div class="choice" onclick="selectChoice(${index})">${choice}</div>
    `).join('');
    
    const answerList = document.getElementById('answerList');
    if (answerList) {
        answerList.innerHTML = '<h4>ğŸ“Š å›ç­”çŠ¶æ³</h4>';
    }
    
    updateTimerDisplay();
}

function updateOnlineTimer(timeLeft) {
    gameState.timeLeft = timeLeft;
    updateTimerDisplay();
}

function handleOnlineAnswerReceived(data) {
    const answerData = {
        playerId: data.playerId,
        playerName: data.playerName,
        answer: data.answerIndex,
        timeLeft: data.timeLeft,
        order: data.answerOrder
    };
    
    gameState.currentAnswers.push(answerData);
    
    const answerList = document.getElementById('answerList');
    if (answerList) {
        const isYou = data.playerId === gameState.onlineState.playerId;
        
        let currentHTML = answerList.innerHTML;
        if (!currentHTML.includes('<h4>ğŸ“Š å›ç­”çŠ¶æ³</h4>')) {
            currentHTML = '<h4>ğŸ“Š å›ç­”çŠ¶æ³</h4>';
        }
        
        const newAnswerHTML = `
            <div class="answer-item">
                <div>
                    <span class="answer-order">${data.answerOrder}ç•ªç›®</span>
                    <span>ğŸ‘¤ ${data.playerName}${isYou ? ' (ã‚ãªãŸ)' : ''}</span>
                </div>
                <div>
                    <span>â±ï¸ ${data.timeLeft}ç§’</span>
                </div>
            </div>
        `;
        
        answerList.innerHTML = currentHTML + newAnswerHTML;
    }
}

function handleOnlineQuestionEnd(data) {
    const question = data.question;
    const choices = document.querySelectorAll('.choice');
    
    choices.forEach(choice => {
        choice.style.pointerEvents = 'none';
        choice.classList.add('disabled');
    });
    
    if (choices[question.correct]) {
        choices[question.correct].classList.add('correct');
    }
    
    data.results.forEach(result => {
        if (result.answer !== question.correct && result.answer >= 0 && choices[result.answer]) {
            choices[result.answer].classList.add('incorrect');
        }
    });
    
    const answerList = document.getElementById('answerList');
    if (answerList) {
        const correctAnswers = data.results.filter(r => r.correct).sort((a, b) => b.timeLeft - a.timeLeft);
        
        let logHTML = '<h4>ğŸ† å›ç­”çµæœ</h4>';
        if (correctAnswers.length > 0) {
            logHTML += correctAnswers.map((result, index) => {
                const isYou = result.playerId === gameState.onlineState.playerId;
                return `
                    <div class="answer-item correct">
                        <div>
                            <span class="answer-order">${index + 1}ä½</span>
                            <span>ğŸ‘¤ ${result.playerName}${isYou ? ' (ã‚ãªãŸ)' : ''}</span>
                        </div>
                        <div>
                            <span class="answer-points">ğŸ† +${result.points || 0}pt</span>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            logHTML += '<div class="answer-item">âŒ æ­£è§£è€…ãªã—</div>';
        }
        
        answerList.innerHTML = logHTML;
    }
}

function showOnlineResults(finalScores) {
    showScreen('resultScreen');
    
    const sortedScores = finalScores.sort((a, b) => b.score - a.score);
    
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = sortedScores.map((player, index) => {
        const isYou = player.playerId === gameState.onlineState.playerId;
        return `
            <div class="rank-item rank-${Math.min(index + 1, 3)}">
                <div>
                    <span class="rank-number">${index + 1}</span>
                    <span>ğŸ‘¤ ${player.playerName}${isYou ? ' (ã‚ãªãŸ)' : ''}</span>
                </div>
                <div>ğŸ† ${player.score}ãƒã‚¤ãƒ³ãƒˆ</div>
            </div>
        `;
    }).join('');
}

function leaveOnlineRoom() {
    if (gameState.onlineState.playerId && gameState.onlineState.ws) {
        gameState.onlineState.ws.send(JSON.stringify({
            type: 'leaveRoom',
            playerId: gameState.onlineState.playerId,
            roomId: gameState.onlineState.roomId
        }));
    }
    
    gameState.onlineState.roomId = null;
    gameState.onlineState.playerId = null;
    gameState.onlineState.isHost = false;
    
    showScreen('onlineMenuScreen');
}

function showNextQuestionCountdown(count, nextQuestionNumber, totalQuestions) {
    const countdownDiv = document.getElementById('countdown');
    const countdownNumber = document.getElementById('countdown-number');
    const countdownText = document.getElementById('countdown-text');
    
    if (countdownNumber) {
        countdownNumber.textContent = count;
        countdownText.textContent = `æ¬¡ã®å•é¡Œ (ç¬¬${nextQuestionNumber}å•/${totalQuestions}å•) ã¾ã§`;
        
        countdownDiv.style.display = 'block';
        
        countdownNumber.style.transform = 'scale(1.2)';
        setTimeout(() => {
            countdownNumber.style.transform = 'scale(1)';
        }, 200);
        
        if (count <= 0) {
            countdownDiv.style.display = 'none';
        }
    }
}

// åˆæœŸåŒ–
function init() {
    console.log('ğŸ¯ Quiz Battle Premium åˆæœŸåŒ–å®Œäº†');
    
    // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ
    const savedPracticeSettings = localStorage.getItem('practiceSettings');
    if (savedPracticeSettings) {
        try {
            const settings = JSON.parse(savedPracticeSettings);
            if (settings.timeLimit) document.getElementById('practiceTimeLimit').value = settings.timeLimit;
            if (settings.questionCount) document.getElementById('practiceQuestionCount').value = settings.questionCount;
            if (settings.questionOrder) document.getElementById('practiceQuestionOrder').value = settings.questionOrder;
            if (settings.showExplanation !== undefined) document.getElementById('showAnswerExplanation').checked = settings.showExplanation;
            if (settings.showStatistics !== undefined) document.getElementById('showStatistics').checked = settings.showStatistics;
            if (settings.reviewIncorrect !== undefined) document.getElementById('reviewIncorrect').checked = settings.reviewIncorrect;
        } catch (error) {
            console.log('ç·´ç¿’è¨­å®šã®å¾©å…ƒã«å¤±æ•—:', error);
        }
    }
    
    // è¨­å®šå¤‰æ›´æ™‚ã®è‡ªå‹•ä¿å­˜
    const practiceSettings = ['practiceTimeLimit', 'practiceQuestionCount', 'practiceQuestionOrder', 'showAnswerExplanation', 'showStatistics', 'reviewIncorrect'];
    practiceSettings.forEach(settingId => {
        const element = document.getElementById(settingId);
        if (element) {
            element.addEventListener('change', savePracticeSettings);
        }
    });
}

// ç·´ç¿’è¨­å®šã®ä¿å­˜
function savePracticeSettings() {
    const settings = {
        timeLimit: document.getElementById('practiceTimeLimit').value,
        questionCount: document.getElementById('practiceQuestionCount').value,
        questionOrder: document.getElementById('practiceQuestionOrder').value,
        showExplanation: document.getElementById('showAnswerExplanation').checked,
        showStatistics: document.getElementById('showStatistics').checked,
        reviewIncorrect: document.getElementById('reviewIncorrect').checked
    };
    
    localStorage.setItem('practiceSettings', JSON.stringify(settings));
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
document.addEventListener('keydown', function(event) {
    // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    if (gameState.mode === 'practice' && document.getElementById('quizScreen').classList.contains('active')) {
        // æ•°å­—ã‚­ãƒ¼1-3ã§é¸æŠè‚¢ã‚’é¸æŠ
        if (event.key >= '1' && event.key <= '3' && !gameState.hasAnswered) {
            const choiceIndex = parseInt(event.key) - 1;
            selectPracticeChoice(choiceIndex);
        }
        // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¹ã‚­ãƒƒãƒ—
        else if (event.key === ' ' && !gameState.hasAnswered) {
            event.preventDefault();
            skipQuestion();
        }
        // Enterã‚­ãƒ¼ã§æ¬¡ã®å•é¡Œï¼ˆå›ç­”å¾Œï¼‰
        else if (event.key === 'Enter' && gameState.hasAnswered) {
            nextPracticeQuestion();
        }
    }
    
    // å…¨ãƒ¢ãƒ¼ãƒ‰å…±é€šã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    // Escapeã‚­ãƒ¼ã§ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
    if (event.key === 'Escape') {
        if (confirm('ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿé€²è¡Œä¸­ã®ã‚²ãƒ¼ãƒ ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
            showHome();
        }
    }
});

// ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹å‰ã®ç¢ºèªï¼ˆã‚²ãƒ¼ãƒ ä¸­ã®ã¿ï¼‰
window.addEventListener('beforeunload', function(event) {
    if (gameState.mode !== 'local' && gameState.currentQuestion > 0 && gameState.currentQuestion < gameState.questions.length) {
        event.preventDefault();
        event.returnValue = 'ã‚²ãƒ¼ãƒ ãŒé€²è¡Œä¸­ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¾ã™ã‹ï¼Ÿ';
        return event.returnValue;
    }
});

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', init);

// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ï¼ˆé–‹ç™ºç”¨ï¼‰
if (typeof performance !== 'undefined' && performance.mark) {
    performance.mark('quiz-app-start');
    window.addEventListener('load', () => {
        performance.mark('quiz-app-loaded');
        performance.measure('quiz-app-load-time', 'quiz-app-start', 'quiz-app-loaded');
        console.log('âš¡ ã‚¢ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ™‚é–“:', performance.getEntriesByName('quiz-app-load-time')[0].duration + 'ms');
    });
}

// ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²ï¼ˆPWAå¯¾å¿œï¼‰
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
                console.log('ServiceWorker registered: ', registration.scope);
            })
            .catch((registrationError) => {
                console.log('ServiceWorker registration failed: ', registrationError);
            });
    });
}

// ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
window.addEventListener('online', () => {
    console.log('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«æˆ»ã‚Šã¾ã—ãŸ');
    if (gameState.mode === 'online' && !gameState.onlineState.connected) {
        initWebSocket();
    }
});

window.addEventListener('offline', () => {
    console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸ');
    updateConnectionStatus(false);
});

// ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
let touchStartY = 0;
let touchEndY = 0;

document.addEventListener('touchstart', function(event) {
    touchStartY = event.changedTouches[0].screenY;
}, false);

document.addEventListener('touchend', function(event) {
    touchEndY = event.changedTouches[0].screenY;
    handleSwipe();
}, false);

function handleSwipe() {
    const swipeThreshold = 100;
    const swipeDistance = touchStartY - touchEndY;
    
    // ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—ã§ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã¿ï¼‰
    if (gameState.mode === 'practice' && 
        document.getElementById('quizScreen').classList.contains('active') && 
        swipeDistance > swipeThreshold && 
        !gameState.hasAnswered) {
        skipQuestion();
    }
}

// ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
}

// ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã®å¾©å…ƒ
function loadDarkModePreference() {
    const savedDarkMode = localStorage.getItem('darkMode');
    if (savedDarkMode === 'true') {
        document.body.classList.add('dark-mode');
    }
}

// éŸ³å£°åŠ¹æœï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
const sounds = {
    correct: () => {
        if (typeof AudioContext !== 'undefined') {
            const audioContext = new AudioContext();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
    },
    
    incorrect: () => {
        if (typeof AudioContext !== 'undefined') {
            const audioContext = new AudioContext();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(220, audioContext.currentTime); // A3
            oscillator.frequency.setValueAtTime(196, audioContext.currentTime + 0.15); // G3
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
    }
};

// éŸ³å£°åŠ¹æœã®å†ç”Ÿï¼ˆè¨­å®šã§æœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
function playSound(soundType) {
    const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
    if (soundEnabled && sounds[soundType]) {
        sounds[soundType]();
    }
}

// çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿
function savePracticeStatistics(stats) {
    const allStats = JSON.parse(localStorage.getItem('practiceStatistics') || '[]');
    allStats.push({
        ...stats,
        date: new Date().toISOString(),
        categories: [...gameState.practiceState.selectedCategories]
    });
    
    // æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
    if (allStats.length > 100) {
        allStats.splice(0, allStats.length - 100);
    }
    
    localStorage.setItem('practiceStatistics', JSON.stringify(allStats));
}

function getPracticeStatistics() {
    return JSON.parse(localStorage.getItem('practiceStatistics') || '[]');
}

// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
function exportCustomQuestions() {
    const saved = localStorage.getItem('customQuestions');
    const questions = saved ? JSON.parse(saved) : [];
    
    const dataStr = JSON.stringify(questions, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'custom_questions.json';
    link.click();
}

function importCustomQuestions(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const questions = JSON.parse(e.target.result);
            if (Array.isArray(questions)) {
                localStorage.setItem('customQuestions', JSON.stringify(questions));
                updateQuestionList();
                alert(`${questions.length}å•ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`);
            } else {
                alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
            }
        } catch (error) {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    };
    reader.readAsText(file);
}

// ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰
if (typeof window !== 'undefined') {
    window.QuizDebug = {
        setScore: (score) => {
            if (gameState.mode === 'practice') {
                gameState.scores.practice = score;
                console.log(`ã‚¹ã‚³ã‚¢ã‚’${score}ã«è¨­å®šã—ã¾ã—ãŸ`);
            }
        },
        skipToResults: () => {
            if (gameState.mode === 'practice') {
                showPracticeResults();
                console.log('çµæœç”»é¢ã«ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
            }
        },
        clearStats: () => {
            localStorage.removeItem('practiceStatistics');
            console.log('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        },
        getGameState: () => {
            return gameState;
        }
    };
}
    </script>
</body>
</html>
