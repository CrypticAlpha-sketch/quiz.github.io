<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>早押しクイズバトル</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            
            --bg-primary: #0a0e27;
            --bg-secondary: #1a1f3a;
            --bg-tertiary: #252a4a;
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-glass: rgba(255, 255, 255, 0.1);
            
            --text-primary: #ffffff;
            --text-secondary: #a0a3bd;
            --text-dark: #2c3e50;
            
            --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 16px 64px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 40px rgba(102, 126, 234, 0.3);
            
            --border-radius: 16px;
            --border-radius-lg: 24px;
            --border-radius-xl: 32px;
            
            --transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-fast: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, transparent 24%, rgba(255, 255, 255, 0.02) 25%, rgba(255, 255, 255, 0.02) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, 0.02) 75%, rgba(255, 255, 255, 0.02) 76%, transparent 77%),
                linear-gradient(-45deg, transparent 24%, rgba(255, 255, 255, 0.02) 25%, rgba(255, 255, 255, 0.02) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, 0.02) 75%, rgba(255, 255, 255, 0.02) 76%, transparent 77%);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 1;
        }

        .main-container {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .container {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-xl);
            padding: 3rem;
            box-shadow: var(--shadow-heavy), var(--shadow-glow);
            max-width: 1000px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
        }

        .container > * {
            position: relative;
            z-index: 1;
        }

        h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            text-align: center;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 3rem;
            text-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            position: relative;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }

        h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 2rem;
            text-align: center;
        }

        h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1rem;
        }

        .screen {
            display: none;
            animation: slideInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .screen.active {
            display: block;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: var(--shadow-medium); }
            50% { box-shadow: var(--shadow-medium), var(--shadow-glow); }
        }

        /* モード選択画面 */
        .mode-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .mode-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            border: 2px solid transparent;
            border-radius: var(--border-radius-lg);
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .mode-card:hover::before {
            left: 100%;
        }

        .mode-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-heavy);
            border-image: var(--primary-gradient) 1;
        }

        .mode-card .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }

        .mode-card h3 {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
            color: #2c3e50; /* より濃い色に変更 */
        }

        .mode-card p {
            color: #34495e; /* より濃い色に変更 */
            font-size: 1rem;
            line-height: 1.6;
        }

        /* ボタンスタイル */
        .btn {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-block;
            margin: 0.5rem;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-medium);
        }

        .btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--success-gradient);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: var(--text-primary);
        }

        .btn-secondary {
            background: var(--dark-gradient);
            color: var(--text-primary);
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: var(--text-dark);
        }

        /* フォーム要素 */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        /* カテゴリー選択 */
        .category-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .category-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .category-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            transition: all 0.6s ease;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        .category-item:hover::before {
            width: 300px;
            height: 300px;
        }

        .category-item:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: #667eea;
            box-shadow: var(--shadow-medium);
        }

        .category-item.selected {
            background: var(--primary-gradient);
            color: var(--text-primary);
            transform: scale(1.05);
            box-shadow: var(--shadow-glow);
        }

        .category-item h4 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        /* クイズ画面 */
        .quiz-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .question-number {
            font-size: 1.4rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .timer {
            font-size: 4rem;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            animation: pulse 1s infinite;
        }

        .game-mode-info {
            font-size: 1rem;
            font-weight: 500;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.2) 0%, rgba(0, 242, 254, 0.2) 100%);
            color: #0891b2;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            border: 1px solid rgba(8, 145, 178, 0.3);
        }

        .question {
            font-size: 1.6rem;
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 2rem;
            text-align: center;
            padding: 2.5rem;
            background: var(--primary-gradient);
            color: var(--text-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-heavy);
            position: relative;
            overflow: hidden;
        }

        .question::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .choices {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .choice {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
        }

        .choice::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.6s;
        }

        .choice:hover::before {
            left: 100%;
        }

        .choice:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: #667eea;
            box-shadow: var(--shadow-medium);
        }

        .choice.selected {
            animation: choiceSelect 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        @keyframes choiceSelect {
            0% { transform: scale(1); }
            30% { transform: scale(1.05); }
            60% { transform: scale(0.98); }
            100% { transform: scale(1.02); }
        }

        .choice.correct {
            background: var(--success-gradient);
            color: var(--text-primary);
            border-color: #4facfe;
            animation: correctAnswer 1s ease;
        }

        @keyframes correctAnswer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .choice.incorrect {
            background: var(--danger-gradient);
            color: var(--text-primary);
            border-color: #ff6b6b;
            animation: incorrectAnswer 0.8s ease;
        }

        @keyframes incorrectAnswer {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .choice.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* 回答ログ */
        .answer-log {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-top: 2rem;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .answer-log h4 {
            color: #667eea;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .answer-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-light);
            border-left: 4px solid transparent;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .answer-item:hover {
            transform: translateX(10px);
            box-shadow: var(--shadow-medium);
        }

        .answer-item.correct {
            border-left-color: #4facfe;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
        }

        .answer-item.incorrect {
            border-left-color: #ff6b6b;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(238, 90, 36, 0.1) 100%);
        }

        .answer-order {
            font-weight: 700;
            color: #667eea;
            margin-right: 1rem;
            font-size: 1.1rem;
        }

        .answer-points {
            font-weight: 700;
            color: #4facfe;
            font-size: 1.1rem;
        }

        /* 結果画面 */
        .results {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .rank-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .rank-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.8s;
        }

        .rank-item:hover::before {
            left: 100%;
        }

        .rank-item:hover {
            transform: translateX(15px) scale(1.02);
            box-shadow: var(--shadow-medium);
        }

        .rank-1 {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            font-size: 1.2rem;
            font-weight: 700;
            animation: glow 2s infinite alternate;
        }

        .rank-2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            font-weight: 600;
        }

        .rank-3 {
            background: linear-gradient(135deg, #cd7f32 0%, #e6a85c 100%);
            font-weight: 600;
        }

        .rank-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #667eea;
            margin-right: 1.5rem;
        }

        /* プレイヤー管理 */
        .player-list,
        .online-players {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1.5rem 0;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .player-item,
        .online-player {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            border-left: 4px solid transparent;
            backdrop-filter: blur(10px);
            color: #2c3e50; /* 濃い色を追加 */
        }

        .player-item:hover,
        .online-player:hover {
            transform: translateX(10px);
            box-shadow: var(--shadow-medium);
        }

        .player-item.ready,
        .online-player.ready {
            border-left-color: #00d084; /* 左の線を緑に */
            background: linear-gradient(135deg, rgba(0, 208, 132, 0.15) 0%, rgba(0, 208, 132, 0.08) 100%); /* 背景を薄い緑に */
            color: #ffffff;
            border: 2px solid rgba(0, 208, 132, 0.4); /* 全体の枠線を緑に */
            box-shadow: 0 4px 12px rgba(0, 208, 132, 0.2); /* 緑の影を追加 */
        }

        /* ルーム情報 */
        .room-id {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin: 2rem 0;
            padding: 1.5rem;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

            .room-info {
                background: transparent; /* var(--primary-gradient)から変更 */
                color: var(--text-primary);
                padding: 1.5rem;
                border-radius: var(--border-radius);
                margin-bottom: 2rem;
                text-align: center;
                font-size: 1.3rem;
                font-weight: 600;
                box-shadow: none; /* var(--shadow-medium)から変更 */
            }

        /* ラベル */
        .you-label,
        .host-label {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .you-label {
            background: var(--success-gradient);
            color: var(--text-primary);
        }

        .host-label {
            background: var(--warning-gradient);
            color: var(--text-dark);
        }

        .ready-status {
            font-size: 0.9rem;
            color: #34495e; /* より濃い色に変更 */
            font-weight: 500;
        }

        .player-item.ready .ready-status,
        .online-player.ready .ready-status {
            color: #ffffff;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4aa 0%, #01a3a4 100%); /* 明るい緑のグラデーション */
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
            border: 2px solid #00d4aa; /* 緑の枠線 */
            box-shadow: 0 2px 8px rgba(0, 212, 170, 0.3); /* 緑の影で光る効果 */
        }

        /* センター配置 */
        .center {
            text-align: center;
            margin: 2rem 0;
        }

        /* 接続状態 */
        .connection-status {
            position: fixed;
            top: 2rem;
            left: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-medium);
            transition: var(--transition);
        }

        .connection-status.connected {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.9) 0%, rgba(0, 242, 254, 0.9) 100%);
            color: var(--text-primary);
        }

        .connection-status.disconnected {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9) 0%, rgba(238, 90, 36, 0.9) 100%);
            color: var(--text-primary);
        }

        /* 問題作成 */
        .question-form {
            background: linear-gradient(135deg, rgba(26, 31, 58, 0.95) 0%, rgba(37, 42, 74, 0.85) 100%); /* 白から暗い色に変更 */
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .question-list {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
            background: linear-gradient(135deg, rgba(26, 31, 58, 0.95) 0%, rgba(37, 42, 74, 0.85) 100%); /* 背景を追加 */
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .question-list::-webkit-scrollbar {
            width: 8px;
        }

        .question-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .question-list::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
        }

        .question-list::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .question-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #2c3e50; /* 濃い文字色を追加 */
        }

        .question-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder,
        .form-group select::placeholder {
            color: #6c757d; /* プレースホルダーを濃いグレーに */
            opacity: 1;
        }
        
        /* ローディングアニメーション */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* レスポンシブデザイン */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .container {
                padding: 2rem;
                margin: 1rem;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            h2 {
                font-size: 1.8rem;
            }
            
            .question {
                font-size: 1.3rem;
                padding: 2rem;
            }
            
            .timer {
                font-size: 3rem;
            }
            
            .mode-selection {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .category-selection {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .rank-item {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }
            
            .rank-number {
                margin-bottom: 0.5rem;
                margin-right: 0;
            }
            
            .connection-status {
                top: 1rem;
                left: 1rem;
                font-size: 0.8rem;
                padding: 0.8rem 1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 1.5rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .question {
                font-size: 1.1rem;
                padding: 1.5rem;
            }
            
            .timer {
                font-size: 2.5rem;
            }
            
            .btn {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
            }
        }

        /* 高コントラストモード対応 */
        @media (prefers-contrast: high) {
            :root {
                --bg-card: rgba(255, 255, 255, 1);
                --text-secondary: #333333;
            }
            
            .choice {
                border-width: 3px;
                color: #2c3e50; /* 濃い色を追加 */
                font-size: 1.1rem;
                font-weight: 600; /* フォントウェイトを少し太くして見やすく */
            }
            
            .category-item {
                border-width: 3px;
            }
        }

        /* 縮小モーション対応 */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ダークモード対応（将来の拡張用） */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-card: rgba(26, 31, 58, 0.95);
                --text-dark: #ffffff;
            }
        }
    </style>
</head>
<body>
    <!-- 接続状態 -->
    <div class="connection-status disconnected" id="connectionStatus" style="display: none;">
        ❌ オフライン
    </div>

    <div class="main-container">
        <div class="container">
            <h1>🎯 クイズ大会</h1>

            <!-- ホーム画面 -->
            <div id="homeScreen" class="screen active">
                <div class="mode-selection">
                    <div class="mode-card" onclick="startLocalGame()">
                        <span class="icon">🏠</span>
                        <h3>ローカル対戦</h3>
                        <p>同じ端末でリアルタイム対戦を楽しもう</p>
                    </div>
                    <div class="mode-card" onclick="showOnlineMenu()">
                        <span class="icon">🌐</span>
                        <h3>オンライン対戦</h3>
                        <p>世界中のプレイヤーと白熱バトル</p>
                    </div>
                </div>
                <div class="center">
                    <button class="btn btn-warning" onclick="showQuestionCreator()">
                        ✏️ オリジナル問題を作成
                    </button>
                </div>
            </div>

            <!-- オンラインメニュー -->
            <div id="onlineMenuScreen" class="screen">
                <h2>🌐 オンライン対戦</h2>
                <div class="form-group">
                    <label>プレイヤー名</label>
                    <input type="text" id="onlinePlayerName" placeholder="あなたの名前を入力してください">
                </div>
                <div class="center">
                    <button class="btn btn-success" onclick="createRoom()">
                        🏗️ ルームを作成
                    </button>
                    <button class="btn btn-primary" onclick="showJoinRoom()">
                        🚪 ルームに参加
                    </button>
                    <button class="btn btn-danger" onclick="showHome()">
                        ← 戻る
                    </button>
                </div>
            </div>

            <!-- ルーム参加画面 -->
            <div id="joinRoomScreen" class="screen">
                <h2>🚪 ルーム参加</h2>
                <div class="form-group">
                    <label>ルームID</label>
                    <input type="text" id="roomIdInput" placeholder="ルームIDを入力してください">
                </div>
                <div class="center">
                    <button class="btn btn-success" onclick="joinRoom()">
                        ✨ 参加する
                    </button>
                    <button class="btn btn-danger" onclick="showOnlineMenu()">
                        ← 戻る
                    </button>
                </div>
            </div>

            <!-- オンライン待機室 -->
            <div id="onlineWaitingScreen" class="screen">
                <h2>🏛️ オンライン待機室</h2>
                <div id="roomIdDisplay" class="room-info"></div>
                
                <div class="player-section">
                    <h3>🎭 参加プレイヤー</h3>
                    <div id="onlinePlayerList"></div>
                </div>
                
                <div class="center">
                    <button class="btn btn-primary" onclick="togglePlayerReady()">
                        🎯 準備完了/解除
                    </button>
                    <button id="startOnlineGameBtn" class="btn btn-success" onclick="startOnlineGame()" style="display: none;">
                        🚀 ゲーム開始
                    </button>
                    <button class="btn btn-secondary" onclick="leaveOnlineRoom()">
                        🚪 ルーム退出
                    </button>
                </div>
            </div>

            <!-- プレイヤー登録画面（ローカル） -->
            <div id="playerScreen" class="screen">
                <h2>👥 プレイヤー登録</h2>
                <div class="form-group">
                    <input type="text" id="playerName" placeholder="プレイヤー名を入力してください" onkeypress="if(event.key==='Enter')addPlayer()">
                </div>
                <button class="btn btn-success" onclick="addPlayer()">
                    ➕ プレイヤーを追加
                </button>
                
                <div class="player-list">
                    <h3>🎭 参加プレイヤー</h3>
                    <div id="playerList"></div>
                </div>
                
                <div class="center">
                    <button class="btn btn-primary" onclick="showCategorySelection()" id="startBtn" style="display:none;">
                        ⏭️ 次へ
                    </button>
                    <button class="btn btn-danger" onclick="showHome()">
                        ← 戻る
                    </button>
                </div>
            </div>

            <!-- カテゴリー選択画面 -->
            <div id="categoryScreen" class="screen">
                <h2>📚 カテゴリー選択</h2>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">
                    挑戦したいカテゴリーを選択してください（複数選択可能）
                </p>
                <div class="category-selection" id="categorySelection">
                    <div class="category-item" data-category="general" onclick="toggleCategory('general')">
                        <h4>📚 一般常識</h4>
                    </div>
                    <div class="category-item" data-category="geography" onclick="toggleCategory('geography')">
                        <h4>🌏 地理</h4>
                    </div>
                    <div class="category-item" data-category="history" onclick="toggleCategory('history')">
                        <h4>📜 歴史</h4>
                    </div>
                    <div class="category-item" data-category="science" onclick="toggleCategory('science')">
                        <h4>🔬 科学</h4>
                    </div>
                    <div class="category-item" data-category="sports" onclick="toggleCategory('sports')">
                        <h4>⚽ スポーツ</h4>
                    </div>
                    <div class="category-item" data-category="entertainment" onclick="toggleCategory('entertainment')">
                        <h4>🎬 エンタメ</h4>
                    </div>
                    <div class="category-item" data-category="custom" onclick="toggleCategory('custom')">
                        <h4>✏️ カスタム</h4>
                    </div>
                </div>
                <div class="center">
                    <button class="btn btn-success" onclick="startGameWithCategories()">
                        🚀 ゲーム開始
                    </button>
                    <button class="btn btn-danger" onclick="showPlayerRegistration()">
                        ← 戻る
                    </button>
                </div>
            </div>

            <!-- クイズ画面 -->
            <div id="quizScreen" class="screen">
                <div class="quiz-header">
                    <div class="question-number" id="questionNumber">第1問 / 6問</div>
                    <div class="timer" id="timer">15</div>
                    <div class="game-mode-info">
                        ⚡ 正解者全員にポイント！早押しで高得点を狙え！
                    </div>
                </div>
                
                <div class="question" id="questionText">
                    問題文がここに表示されます
                </div>
                
                <div class="choices" id="choices">
                    <div class="choice" onclick="selectChoice(0)">選択肢1</div>
                    <div class="choice" onclick="selectChoice(1)">選択肢2</div>
                    <div class="choice" onclick="selectChoice(2)">選択肢3</div>
                </div>
                
                <!-- 回答者表示エリア -->
                <div class="answer-log" id="answerLog">
                    <h4>📊 回答状況</h4>
                    <div id="answerList"></div>
                </div>
            </div>

            <!-- 結果画面 -->
            <div id="resultScreen" class="screen">
                <h2>🏆 最終結果</h2>
                <div class="results" id="results"></div>
                <div class="center">
                    <button class="btn btn-primary" onclick="resetGame()">
                        🔄 もう一度プレイ
                    </button>
                    <button class="btn btn-danger" onclick="showHome()">
                        🏠 ホームに戻る
                    </button>
                </div>
            </div>

            <!-- 問題作成画面 -->
            <div id="questionCreatorScreen" class="screen">
                <h2>✏️ オリジナル問題作成</h2>
                <div class="question-form">
                    <div class="form-group">
                        <label>📁 カテゴリー</label>
                        <select id="questionCategory">
                            <option value="general">📚 一般常識</option>
                            <option value="geography">🌏 地理</option>
                            <option value="history">📜 歴史</option>
                            <option value="science">🔬 科学</option>
                            <option value="sports">⚽ スポーツ</option>
                            <option value="entertainment">🎬 エンタメ</option>
                            <option value="custom">✏️ カスタム</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>❓ 問題文</label>
                        <textarea id="newQuestion" placeholder="魅力的な問題文を入力してください"></textarea>
                    </div>
                    <div class="form-group">
                        <label>🅰️ 選択肢1</label>
                        <input type="text" id="choice1" placeholder="選択肢1を入力">
                    </div>
                    <div class="form-group">
                        <label>🅱️ 選択肢2</label>
                        <input type="text" id="choice2" placeholder="選択肢2を入力">
                    </div>
                    <div class="form-group">
                        <label>🅲️ 選択肢3</label>
                        <input type="text" id="choice3" placeholder="選択肢3を入力">
                    </div>
                    <div class="form-group">
                        <label>✅ 正解の選択肢番号（1-3）</label>
                        <input type="number" id="correctAnswer" min="1" max="3" placeholder="1">
                    </div>
                    <button class="btn btn-success" onclick="addQuestion()">
                        ➕ 問題を追加
                    </button>
                </div>
                
                <div class="question-list">
                    <h3>📝 登録済みの問題</h3>
                    <div id="questionList"></div>
                </div>
                
                <div class="center">
                    <button class="btn btn-danger" onclick="showHome()">
                        ← 戻る
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// ゲーム状態
let gameState = {
    mode: 'local', // local, online
    players: [],
    currentQuestion: 0,
    questions: [],
    timer: null,
    timeLeft: 15,
    scores: {},
    selectedCategories: [],
    currentAnswers: [],
    hasAnswered: false, // オンライン時の重複回答防止
    onlineState: {
        ws: null,
        roomId: null,
        playerId: null,
        isHost: false,
        connected: false
    }
};

// デフォルトの問題（カテゴリー別）
const defaultQuestions = {
    general: [
        {
            question: "日本の首都はどこですか？",
            choices: ["大阪", "東京", "京都"],
            correct: 1,
            category: "general"
        },
        {
            question: "日本の通貨単位は？",
            choices: ["ウォン", "元", "円"],
            correct: 2,
            category: "general"
        },
        {
            question: "日本の国花は？",
            choices: ["桜", "菊", "梅"],
            correct: 0,
            category: "general"
        }
    ],
    geography: [
        {
            question: "富士山の高さは？",
            choices: ["3,776m", "3,676m", "3,876m"],
            correct: 0,
            category: "geography"
        },
        {
            question: "日本で一番大きな湖は？",
            choices: ["霞ヶ浦", "琵琶湖", "洞爺湖"],
            correct: 1,
            category: "geography"
        },
        {
            question: "日本で一番長い川は？",
            choices: ["利根川", "信濃川", "石狩川"],
            correct: 1,
            category: "geography"
        }
    ],
    history: [
        {
            question: "鎌倉幕府を開いたのは誰？",
            choices: ["源頼朝", "足利尊氏", "徳川家康"],
            correct: 0,
            category: "history"
        },
        {
            question: "明治維新は何年？",
            choices: ["1868年", "1858年", "1878年"],
            correct: 0,
            category: "history"
        },
        {
            question: "第二次世界大戦が終わった年は？",
            choices: ["1944年", "1945年", "1946年"],
            correct: 1,
            category: "history"
        }
    ],
    science: [
        {
            question: "水の化学式は？",
            choices: ["CO2", "H2O", "O2"],
            correct: 1,
            category: "science"
        },
        {
            question: "光の速度は約？",
            choices: ["30万km/秒", "3万km/秒", "300万km/秒"],
            correct: 0,
            category: "science"
        },
        {
            question: "地球から太陽までの距離は約？",
            choices: ["1億5000万km", "1000万km", "10億km"],
            correct: 0,
            category: "science"
        }
    ],
    sports: [
        {
            question: "東京オリンピック2020の開催年は？",
            choices: ["2020年", "2021年", "2022年"],
            correct: 1,
            category: "sports"
        },
        {
            question: "サッカーのワールドカップは何年ごと？",
            choices: ["2年", "3年", "4年"],
            correct: 2,
            category: "sports"
        },
        {
            question: "野球で1イニングに投手が投げる最少球数は？",
            choices: ["3球", "6球", "9球"],
            correct: 0,
            category: "sports"
        }
    ],
    entertainment: [
        {
            question: "ジブリ作品「千と千尋の神隠し」の監督は？",
            choices: ["宮崎駿", "高畑勲", "細田守"],
            correct: 0,
            category: "entertainment"
        },
        {
            question: "「鬼滅の刃」の主人公の名前は？",
            choices: ["竈門炭治郎", "我妻善逸", "嘴平伊之助"],
            correct: 0,
            category: "entertainment"
        },
        {
            question: "ポケモンの最初の御三家は？",
            choices: ["フシギダネ・ヒトカゲ・ゼニガメ", "チコリータ・ヒノアラシ・ワニノコ", "キモリ・アチャモ・ミズゴロウ"],
            correct: 0,
            category: "entertainment"
        }
    ]
};

// カスタム問題管理
let customQuestions = [];

// WebSocket接続管理
function initWebSocket() {
    const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
    
    let wsUrl;
    if (isProduction) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        wsUrl = `${protocol}//${window.location.host}`;
    } else {
        wsUrl = 'ws://localhost:8080';
    }
    
    console.log('WebSocket接続先:', wsUrl);
    
    try {
        gameState.onlineState.ws = new WebSocket(wsUrl);
        
        gameState.onlineState.ws.onopen = () => {
            console.log('WebSocket接続成功');
            updateConnectionStatus(true);
        };
        
        gameState.onlineState.ws.onclose = () => {
            console.log('WebSocket接続切断');
            updateConnectionStatus(false);
            // 再接続を試行
            setTimeout(() => {
                if (!gameState.onlineState.connected) {
                    initWebSocket();
                }
            }, 3000);
        };
        
        gameState.onlineState.ws.onmessage = (event) => {
            handleWebSocketMessage(JSON.parse(event.data));
        };
        
        gameState.onlineState.ws.onerror = (error) => {
            console.error('WebSocketエラー:', error);
            updateConnectionStatus(false);
        };
    } catch (error) {
        console.error('WebSocket接続失敗:', error);
        updateConnectionStatus(false);
    }
}

function handleWebSocketMessage(data) {
    console.log('受信:', data);
    
    switch(data.type) {
        case 'roomCreated':
            gameState.onlineState.roomId = data.roomId;
            gameState.onlineState.playerId = data.playerId;
            gameState.onlineState.isHost = true;
            document.getElementById('roomIdDisplay').innerHTML = `
                <div class="room-info">🏛️ ルームID: ${data.roomId}</div>
            `;
            showScreen('onlineWaitingScreen');
            updateOnlinePlayerList(data.players);
            document.getElementById('startOnlineGameBtn').style.display = 'block';
            break;
            
        case 'joinedRoom':
            gameState.onlineState.roomId = data.roomId;
            gameState.onlineState.playerId = data.playerId;
            gameState.onlineState.isHost = false;
            document.getElementById('roomIdDisplay').innerHTML = `
                <div class="room-info">🏛️ ルームID: ${data.roomId}</div>
            `;
            showScreen('onlineWaitingScreen');
            updateOnlinePlayerList(data.players);
            document.getElementById('startOnlineGameBtn').style.display = 'none';
            break;
            
        case 'playerJoined':
        case 'playerLeft':
        case 'playerReady':
        case 'playerUpdate':
            updateOnlinePlayerList(data.players);
            if (data.type === 'playerLeft' && gameState.onlineState.isHost) {
                document.getElementById('startOnlineGameBtn').style.display = 'block';
            }
            break;
            
        case 'newHost':
            if (data.hostId === gameState.onlineState.playerId) {
                gameState.onlineState.isHost = true;
                document.getElementById('startOnlineGameBtn').style.display = 'block';
            }
            break;
            
        case 'gameStart':
            startOnlineQuiz(data.questions);
            break;
            
        case 'newQuestion':
            showOnlineQuestion(data);
            break;
            
        case 'timerUpdate':
            updateOnlineTimer(data.timeLeft);
            break;
            
        case 'answerReceived':
            handleOnlineAnswerReceived(data);
            break;
            
        case 'questionEnd':
            handleOnlineQuestionEnd(data);
            break;
            
        case 'nextQuestion':
            // 次の問題への準備
            setTimeout(() => {
                console.log('次の問題を待機中...');
            }, 1000);
            break;
            
        case 'gameEnd':
            showOnlineResults(data.finalScores);
            break;
            
        case 'error':
            alert(data.message);
            break;
            
        default:
            console.log('未処理のメッセージタイプ:', data.type);
    }
}

// 接続状態更新
function updateConnectionStatus(connected) {
    gameState.onlineState.connected = connected;
    const statusDiv = document.getElementById('connectionStatus');
    if (statusDiv) {
        statusDiv.textContent = connected ? '✅ オンライン' : '❌ オフライン';
        statusDiv.className = connected ? 'connection-status connected' : 'connection-status disconnected';
        statusDiv.style.display = 'block';
    }
}

// 画面管理
function showScreen(screenId) {
    // オンライン時以外はタイマーを停止
    if (screenId !== 'quizScreen' || gameState.mode === 'local') {
        stopTimer();
    }
    
    const screens = document.querySelectorAll('.screen');
    screens.forEach(screen => screen.classList.remove('active'));
    
    const targetScreen = document.getElementById(screenId);
    if (targetScreen) {
        targetScreen.classList.add('active');
    }
}

function showHome() {
    gameState.players = [];
    gameState.scores = {};
    gameState.currentQuestion = 0;
    gameState.selectedCategories = [];
    stopTimer();
    showScreen('homeScreen');
    if (gameState.onlineState.ws) {
        gameState.onlineState.ws.close();
    }
}

// メインメニュー機能
function startLocalGame() {
    gameState.mode = 'local';
    showScreen('playerScreen');
}

function showOnlineMenu() {
    gameState.mode = 'online';
    showScreen('onlineMenuScreen');
    initWebSocket();
}

function showQuestionCreator() {
    showScreen('questionCreatorScreen');
    updateQuestionList();
}

// プレイヤー管理
function addPlayer() {
    const input = document.getElementById('playerName');
    const playerName = input.value.trim();
    
    if (!playerName) {
        alert('プレイヤー名を入力してください');
        return;
    }
    
    if (gameState.players.some(player => player.name === playerName)) {
        alert('同じ名前のプレイヤーがすでに存在します');
        return;
    }
    
    if (gameState.players.length >= 6) {
        alert('プレイヤーは最大6人までです');
        return;
    }
    
    const player = {
        id: Date.now(),
        name: playerName
    };
    
    gameState.players.push(player);
    gameState.scores[player.id] = 0;
    
    input.value = '';
    updatePlayerList();
    
    const startBtn = document.getElementById('startBtn');
    if (gameState.players.length >= 2 && startBtn) {
        startBtn.style.display = 'block';
    }
}

function updatePlayerList() {
    const playerList = document.getElementById('playerList');
    if (!playerList) return;
    
    playerList.innerHTML = gameState.players.map(player => `
        <div class="player-item">
            <span>👤 ${player.name}</span>
            <button class="btn btn-danger" onclick="removePlayer(${player.id})">🗑️ 削除</button>
        </div>
    `).join('');
}

function removePlayer(playerId) {
    gameState.players = gameState.players.filter(player => player.id !== playerId);
    delete gameState.scores[playerId];
    updatePlayerList();
    
    const startBtn = document.getElementById('startBtn');
    if (gameState.players.length < 2 && startBtn) {
        startBtn.style.display = 'none';
    }
}

// カテゴリ選択
function showCategorySelection() {
    if (gameState.players.length < 2) {
        alert('最低2人のプレイヤーが必要です');
        return;
    }
    showScreen('categoryScreen');
}

function showPlayerRegistration() {
    showScreen('playerScreen');
}

function toggleCategory(categoryKey) {
    const categoryItem = document.querySelector(`[data-category="${categoryKey}"]`);
    if (!categoryItem) return;
    
    const index = gameState.selectedCategories.indexOf(categoryKey);
    if (index === -1) {
        gameState.selectedCategories.push(categoryKey);
        categoryItem.classList.add('selected');
    } else {
        gameState.selectedCategories.splice(index, 1);
        categoryItem.classList.remove('selected');
    }
}

function startGameWithCategories() {
    if (gameState.selectedCategories.length === 0) {
        alert('最低1つのカテゴリを選択してください');
        return;
    }
    
    let questions = loadQuestions();
    
    if (questions.length < 6) {
        alert('選択したカテゴリの問題が少なすぎます（最低6問必要）');
        return;
    }
    
    gameState.questions = shuffleArray(questions).slice(0, 6);
    gameState.currentQuestion = 0;
    gameState.mode = 'local';
    
    gameState.players.forEach(player => {
        gameState.scores[player.id] = 0;
    });
    
    showQuestion();
}

// ローカルストレージから問題を読み込む
function loadQuestions() {
    const saved = localStorage.getItem('customQuestions');
    customQuestions = saved ? JSON.parse(saved) : [];
    
    let allQuestions = [];
    
    gameState.selectedCategories.forEach(category => {
        if (defaultQuestions[category]) {
            allQuestions = allQuestions.concat(defaultQuestions[category]);
        }
        if (category === 'custom') {
            allQuestions = allQuestions.concat(customQuestions);
        }
    });
    
    return allQuestions;
}

// 配列シャッフル
function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}

// 問題表示・管理
function showQuestion() {
    if (gameState.mode === 'local') {
        stopTimer(); // ローカルモード時のみタイマーを停止
    }
    
    if (gameState.currentQuestion >= gameState.questions.length) {
        showResults();
        return;
    }
    
    const question = gameState.questions[gameState.currentQuestion];
    gameState.currentAnswers = [];
    gameState.hasAnswered = false;
    
    showScreen('quizScreen');
    
    document.getElementById('questionText').textContent = question.question;
    document.getElementById('questionNumber').textContent = `第${gameState.currentQuestion + 1}問 / ${gameState.questions.length}問`;
    
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = question.choices.map((choice, index) => `
        <div class="choice" onclick="selectChoice(${index})">${choice}</div>
    `).join('');
    
    document.getElementById('answerList').innerHTML = '';
    
    // ローカル時のみタイマー開始
    if (gameState.mode === 'local') {
        setTimeout(() => {
            startTimer();
        }, 100);
    }
}

// タイマー管理（ローカル専用）
function startTimer() {
    if (gameState.mode === 'online') {
        return; // オンライン時はタイマー制御しない
    }
    
    if (gameState.timer) {
        clearInterval(gameState.timer);
        gameState.timer = null;
    }
    
    const timerElement = document.getElementById('timer');
    if (!timerElement) return;
    
    gameState.timeLeft = 15;
    updateTimerDisplay();
    
    gameState.timer = setInterval(() => {
        gameState.timeLeft--;
        updateTimerDisplay();
        
        if (gameState.timeLeft <= 0) {
            clearInterval(gameState.timer);
            gameState.timer = null;
            handleTimeUp();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('timer');
    if (timerElement) {
        timerElement.textContent = gameState.timeLeft;
    }
}

function handleTimeUp() {
    if (gameState.mode === 'online') {
        return; // オンライン時は時間切れ処理しない
    }
    
    const choices = document.querySelectorAll('.choice');
    choices.forEach(choice => {
        choice.style.pointerEvents = 'none';
        choice.classList.add('disabled');
    });
    
    const question = gameState.questions[gameState.currentQuestion];
    choices[question.correct].classList.add('correct');
    
    setTimeout(() => {
        nextQuestion();
    }, 2000);
}

function stopTimer() {
    if (gameState.timer) {
        clearInterval(gameState.timer);
        gameState.timer = null;
    }
}

// 回答処理
function selectChoice(index) {
    if (gameState.mode === 'local') {
        selectChoiceLocal(index);
    } else {
        selectChoiceOnline(index);
    }
}

function selectChoiceLocal(index) {
    if (gameState.players.length === 1) {
        processAnswer(gameState.players[0].name, index);
    } else {
        showPlayerSelectionDialog(index);
    }
}

function selectChoiceOnline(index) {
    if (gameState.hasAnswered) {
        console.log('既に回答済みです');
        return;
    }
    
    console.log(`選択肢${index}を選択しました`);
    gameState.hasAnswered = true;
    
    const choices = document.querySelectorAll('.choice');
    choices.forEach((choice, i) => {
        if (i === index) {
            choice.classList.add('selected');
        }
        choice.style.pointerEvents = 'none';
        choice.classList.add('disabled');
    });
    
    if (gameState.onlineState.ws && gameState.onlineState.ws.readyState === WebSocket.OPEN) {
        const message = {
            type: 'selectAnswer',
            roomId: gameState.onlineState.roomId,
            playerId: gameState.onlineState.playerId,
            answerIndex: index,
            timeLeft: gameState.timeLeft || 15
        };
        
        console.log('回答送信:', message);
        gameState.onlineState.ws.send(JSON.stringify(message));
    } else {
        console.error('WebSocket接続が無効です');
    }
}

function showPlayerSelectionDialog(choiceIndex) {
    const availablePlayers = gameState.players.filter(player => 
        !gameState.currentAnswers.some(answer => answer.player === player.name)
    );
    
    if (availablePlayers.length === 0) {
        alert('全員が回答済みです');
        return;
    }
    
    const playerList = availablePlayers.map(player => 
        `<button class="btn btn-primary" onclick="processAnswer('${player.name}', ${choiceIndex}); closePlayerDialog()">${player.name}</button>`
    ).join('');
    
    const dialog = document.createElement('div');
    dialog.id = 'playerDialog';
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 14, 39, 0.9);
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    
    dialog.innerHTML = `
        <div style="
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-heavy);
        ">
            <h3 style="color: #667eea; margin-bottom: 1.5rem; font-family: 'Poppins', sans-serif;">
                👤 どのプレイヤーが回答しますか？
            </h3>
            <div style="margin-bottom: 1.5rem;">
                ${playerList}
            </div>
            <button class="btn btn-danger" onclick="closePlayerDialog()">❌ キャンセル</button>
        </div>
    `;
    
    document.body.appendChild(dialog);
}

function closePlayerDialog() {
    const dialog = document.getElementById('playerDialog');
    if (dialog) {
        dialog.remove();
    }
}

function processAnswer(playerName, choiceIndex) {
    if (gameState.currentAnswers.some(answer => answer.player === playerName)) {
        alert('既に回答済みです');
        return;
    }
    
    const question = gameState.questions[gameState.currentQuestion];
    const isCorrect = choiceIndex === question.correct;
    
    const answerData = {
        player: playerName,
        answer: choiceIndex,
        correct: isCorrect,
        timeLeft: gameState.timeLeft,
        order: gameState.currentAnswers.length + 1
    };
    
    gameState.currentAnswers.push(answerData);
    
    // ポイント計算（正解者のみ）
    if (isCorrect) {
        const points = getPointsByOrder(answerData.order);
        const player = gameState.players.find(p => p.name === playerName);
        if (player) {
            gameState.scores[player.id] += points;
        }
    }
    
    // 選択肢の色を更新
    const choices = document.querySelectorAll('.choice');
    if (isCorrect) {
        choices[choiceIndex].classList.add('correct');
    } else {
        choices[choiceIndex].classList.add('incorrect');
        choices[question.correct].classList.add('correct');
    }
    
    updateAnswerLog();
    
    // 全員が回答したか、または時間切れの場合は次の問題へ
    if (gameState.currentAnswers.length >= gameState.players.length) {
        stopTimer();
        setTimeout(() => {
            nextQuestion();
        }, 2000);
    }
}

function updateAnswerLog() {
    const answerList = document.getElementById('answerList');
    if (!answerList) return;
    
    answerList.innerHTML = gameState.currentAnswers.map(answer => `
        <div class="answer-item ${answer.correct ? 'correct' : 'incorrect'}">
            <div>
                <span class="answer-order">${answer.order}位</span>
                <span>👤 ${answer.player}</span>
            </div>
            <div>
                <span class="answer-points">${answer.correct ? getPointsByOrder(answer.order) : 0}pt</span>
            </div>
        </div>
    `).join('');
}

function getPointsByOrder(order) {
    switch(order) {
        case 1: return 100;
        case 2: return 80;
        case 3: return 60;
        default: return 40;
    }
}

function nextQuestion() {
    gameState.currentQuestion++;
    if (gameState.currentQuestion >= gameState.questions.length) {
        showResults();
    } else {
        showQuestion();
    }
}

// 結果表示
function showResults() {
    stopTimer();
    showScreen('resultScreen');
    
    if (gameState.mode === 'local') {
        const sortedPlayers = gameState.players.sort((a, b) => 
            gameState.scores[b.id] - gameState.scores[a.id]
        );
        
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = sortedPlayers.map((player, index) => `
            <div class="rank-item rank-${Math.min(index + 1, 3)}">
                <div>
                    <span class="rank-number">${index + 1}</span>
                    <span>👤 ${player.name}</span>
                </div>
                <div>🏆 ${gameState.scores[player.id]}ポイント</div>
            </div>
        `).join('');
    }
}

function resetGame() {
    gameState.players = [];
    gameState.scores = {};
    gameState.currentQuestion = 0;
    gameState.selectedCategories = [];
    gameState.hasAnswered = false;
    stopTimer();
    showScreen('playerScreen');
}

// 問題作成機能
function addQuestion() {
    const category = document.getElementById('questionCategory').value;
    const questionText = document.getElementById('newQuestion').value.trim();
    const choice1 = document.getElementById('choice1').value.trim();
    const choice2 = document.getElementById('choice2').value.trim();
    const choice3 = document.getElementById('choice3').value.trim();
    const correctAnswer = parseInt(document.getElementById('correctAnswer').value) - 1;
    
    if (!questionText || !choice1 || !choice2 || !choice3) {
        alert('すべての項目を入力してください');
        return;
    }
    
    if (correctAnswer < 0 || correctAnswer > 2) {
        alert('正解の選択肢番号は1-3の範囲で入力してください');
        return;
    }
    
    const newQuestion = {
        question: questionText,
        choices: [choice1, choice2, choice3],
        correct: correctAnswer,
        category: category
    };
    
    const saved = localStorage.getItem('customQuestions');
    customQuestions = saved ? JSON.parse(saved) : [];
    customQuestions.push(newQuestion);
    localStorage.setItem('customQuestions', JSON.stringify(customQuestions));
    
    // フォームクリア
    document.getElementById('newQuestion').value = '';
    document.getElementById('choice1').value = '';
    document.getElementById('choice2').value = '';
    document.getElementById('choice3').value = '';
    document.getElementById('correctAnswer').value = '';
    
    updateQuestionList();
    alert('✅ 問題を追加しました！');
}

function updateQuestionList() {
    const saved = localStorage.getItem('customQuestions');
    customQuestions = saved ? JSON.parse(saved) : [];
    
    const questionList = document.getElementById('questionList');
    if (!questionList) return;
    
    questionList.innerHTML = customQuestions.map((question, index) => `
        <div class="question-item">
            <strong>❓ Q${index + 1}:</strong> ${question.question}<br>
            <small>📁 カテゴリ: ${getCategoryName(question.category)}</small><br>
            <small>📝 選択肢: ${question.choices.join(', ')}</small><br>
            <small>✅ 正解: ${question.choices[question.correct]}</small>
            <button class="btn btn-danger" onclick="removeQuestion(${index})" style="margin-top: 1rem;">
                🗑️ 削除
            </button>
        </div>
    `).join('');
}

function getCategoryName(category) {
    const names = {
        general: '📚 一般常識',
        geography: '🌏 地理',
        history: '📜 歴史',
        science: '🔬 科学',
        sports: '⚽ スポーツ',
        entertainment: '🎬 エンタメ',
        custom: '✏️ カスタム'
    };
    return names[category] || category;
}

function removeQuestion(index) {
    if (confirm('この問題を削除しますか？')) {
        const saved = localStorage.getItem('customQuestions');
        customQuestions = saved ? JSON.parse(saved) : [];
        customQuestions.splice(index, 1);
        localStorage.setItem('customQuestions', JSON.stringify(customQuestions));
        updateQuestionList();
    }
}

// オンライン機能
function createRoom() {
    const playerName = document.getElementById('onlinePlayerName').value.trim();
    if (!playerName) {
        alert('プレイヤー名を入力してください');
        return;
    }
    
    if (!gameState.onlineState.ws || gameState.onlineState.ws.readyState !== WebSocket.OPEN) {
        alert('サーバーに接続されていません');
        return;
    }
    
    gameState.onlineState.ws.send(JSON.stringify({
        type: 'createRoom',
        playerName: playerName
    }));
}

function showJoinRoom() {
    showScreen('joinRoomScreen');
}

function joinRoom() {
    const playerName = document.getElementById('onlinePlayerName').value.trim();
    const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
    
    if (!playerName) {
        alert('プレイヤー名を入力してください');
        return;
    }
    
    if (!roomId) {
        alert('ルームIDを入力してください');
        return;
    }
    
    if (!gameState.onlineState.ws || gameState.onlineState.ws.readyState !== WebSocket.OPEN) {
        alert('サーバーに接続されていません');
        return;
    }
    
    gameState.onlineState.ws.send(JSON.stringify({
        type: 'joinRoom',
        playerName: playerName,
        roomId: roomId
    }));
}

function togglePlayerReady() {
    if (!gameState.onlineState.playerId || !gameState.onlineState.ws || gameState.onlineState.ws.readyState !== WebSocket.OPEN) {
        console.error('WebSocket接続が無効です');
        return;
    }
    
    const message = {
        type: 'toggleReady',
        playerId: gameState.onlineState.playerId,
        roomId: gameState.onlineState.roomId
    };
    
    console.log('準備状態切り替え送信:', message);
    gameState.onlineState.ws.send(JSON.stringify(message));
}

function startOnlineGame() {
    if (!gameState.onlineState.isHost) {
        alert('ホストのみがゲームを開始できます');
        return;
    }
    
    if (!gameState.onlineState.roomId || !gameState.onlineState.playerId) {
        alert('ルーム情報が正しくありません');
        return;
    }
    
    // カテゴリ選択ダイアログを表示
    showCategorySelectionDialog();
}

function showCategorySelectionDialog() {
    const dialog = document.createElement('div');
    dialog.id = 'categoryDialog';
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 14, 39, 0.9);
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    
    const categories = [
        { key: 'general', name: '📚 一般常識' },
        { key: 'geography', name: '🌏 地理' },
        { key: 'history', name: '📜 歴史' },
        { key: 'science', name: '🔬 科学' },
        { key: 'sports', name: '⚽ スポーツ' },
        { key: 'entertainment', name: '🎬 エンタメ' }
    ];
    
    const categoryButtons = categories.map(cat => 
        `<button id="category-${cat.key}" class="category-btn" data-category="${cat.key}" 
                 style="
                    padding: 1rem 1.5rem;
                    margin: 0.5rem;
                    border: 3px solid #667eea;
                    border-radius: var(--border-radius);
                    background: rgba(255, 255, 255, 0.9);
                    color: var(--text-dark);
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 1rem;
                    transition: var(--transition);
                    position: relative;
                    min-width: 140px;
                    text-align: center;
                    backdrop-filter: blur(10px);
                    box-shadow: var(--shadow-light);
                 ">${cat.name}</button>`
    ).join('');
    
    dialog.innerHTML = `
        <div style="
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            text-align: center;
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow-heavy);
        ">
            <h3 style="color: #667eea; margin-bottom: 1.5rem; font-family: 'Poppins', sans-serif; font-size: 1.5rem;">
                📚 問題カテゴリを選択
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                ${categoryButtons}
            </div>
            <div style="margin-bottom: 1.5rem;">
                <button id="selectAllBtn" class="btn btn-success">✅ 全て選択</button>
                <button id="clearAllBtn" class="btn btn-secondary">❌ 全て解除</button>
            </div>
            <div>
                <button id="startGameBtn" class="btn btn-primary">🚀 ゲーム開始</button>
                <button id="cancelBtn" class="btn btn-danger">❌ キャンセル</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    
    // 各カテゴリーボタンに個別にイベントリスナーを追加
    categories.forEach(cat => {
        const button = document.getElementById(`category-${cat.key}`);
        if (button) {
            button.addEventListener('click', function() {
                console.log(`${cat.key}ボタンがクリックされました`);
                toggleDialogCategoryById(cat.key);
            });
        }
    });
    
    document.getElementById('selectAllBtn').addEventListener('click', selectAllCategories);
    document.getElementById('clearAllBtn').addEventListener('click', clearAllCategories);
    document.getElementById('startGameBtn').addEventListener('click', startGameWithSelectedCategories);
    document.getElementById('cancelBtn').addEventListener('click', closeCategoryDialog);
    
    // デフォルトで全カテゴリを選択
    setTimeout(() => {
        selectAllCategories();
    }, 100);
}

let selectedOnlineCategories = [];

// ID指定での個別カテゴリー切り替え関数
function toggleDialogCategoryById(category) {
    console.log('ID指定でカテゴリー切り替え:', category);
    
    const button = document.getElementById(`category-${category}`);
    if (!button) {
        console.error('ボタンが見つかりません（ID指定）:', `category-${category}`);
        return;
    }
    
    const index = selectedOnlineCategories.indexOf(category);
    
    const categories = {
        'general': '📚 一般常識',
        'geography': '🌏 地理', 
        'history': '📜 歴史',
        'science': '🔬 科学',
        'sports': '⚽ スポーツ',
        'entertainment': '🎬 エンタメ'
    };
    
    if (index === -1) {
        // 選択状態にする
        selectedOnlineCategories.push(category);
        
        console.log(`${category}を選択状態に変更`);
        
        // 選択時のスタイル
        button.style.cssText = `
            padding: 1rem 1.5rem;
            margin: 0.5rem;
            border: 3px solid #667eea;
            border-radius: var(--border-radius);
            background: var(--primary-gradient);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: var(--transition);
            position: relative;
            min-width: 140px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-medium);
            transform: scale(1.05);
        `;
        
        button.innerHTML = `✓ ${categories[category]}`;
        
        console.log('選択完了:', category, selectedOnlineCategories);
    } else {
        // 選択解除
        selectedOnlineCategories.splice(index, 1);
        
        console.log(`${category}を非選択状態に変更`);
        
        // 非選択時のスタイル
        button.style.cssText = `
            padding: 1rem 1.5rem;
            margin: 0.5rem;
            border: 3px solid #667eea;
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-dark);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: var(--transition);
            position: relative;
            min-width: 140px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-light);
            transform: scale(1);
        `;
        
        button.innerHTML = categories[category];
        
        console.log('解除完了:', category, selectedOnlineCategories);
    }
}

function selectAllCategories() {
    console.log('全て選択');
    selectedOnlineCategories = ['general', 'geography', 'history', 'science', 'sports', 'entertainment'];
    
    const categories = {
        'general': '📚 一般常識',
        'geography': '🌏 地理',
        'history': '📜 歴史',
        'science': '🔬 科学',
        'sports': '⚽ スポーツ',
        'entertainment': '🎬 エンタメ'
    };
    
    selectedOnlineCategories.forEach(category => {
        const button = document.getElementById(`category-${category}`);
        if (button) {
            button.style.cssText = `
                padding: 1rem 1.5rem;
                margin: 0.5rem;
                border: 3px solid #667eea;
                border-radius: var(--border-radius);
                background: var(--primary-gradient);
                color: var(--text-primary);
                cursor: pointer;
                font-weight: 700;
                font-size: 1rem;
                transition: var(--transition);
                position: relative;
                min-width: 140px;
                text-align: center;
                backdrop-filter: blur(10px);
                box-shadow: var(--shadow-medium);
                transform: scale(1.05);
            `;
            button.innerHTML = `✓ ${categories[category]}`;
        }
    });
}

function clearAllCategories() {
    console.log('全て解除');
    
    const categories = {
        'general': '📚 一般常識',
        'geography': '🌏 地理',
        'history': '📜 歴史',
        'science': '🔬 科学',
        'sports': '⚽ スポーツ',
        'entertainment': '🎬 エンタメ'
    };
    
    const currentSelected = [...selectedOnlineCategories];
    selectedOnlineCategories = [];
    
    currentSelected.forEach(category => {
        const button = document.getElementById(`category-${category}`);
        if (button) {
            button.style.cssText = `
                padding: 1rem 1.5rem;
                margin: 0.5rem;
                border: 3px solid #667eea;
                border-radius: var(--border-radius);
                background: rgba(255, 255, 255, 0.9);
                color: var(--text-dark);
                cursor: pointer;
                font-weight: 600;
                font-size: 1rem;
                transition: var(--transition);
                position: relative;
                min-width: 140px;
                text-align: center;
                backdrop-filter: blur(10px);
                box-shadow: var(--shadow-light);
                transform: scale(1);
            `;
            button.innerHTML = categories[category];
        }
    });
}

function startGameWithSelectedCategories() {
    if (selectedOnlineCategories.length === 0) {
        alert('最低1つのカテゴリを選択してください');
        return;
    }
    
    closeCategoryDialog();
    
    // カスタム問題も含めて送信
    const saved = localStorage.getItem('customQuestions');
    const customQuestions = saved ? JSON.parse(saved) : [];
    
    gameState.onlineState.ws.send(JSON.stringify({
        type: 'startGame',
        roomId: gameState.onlineState.roomId,
        playerId: gameState.onlineState.playerId,
        categories: selectedOnlineCategories,
        questions: customQuestions
    }));
}

function closeCategoryDialog() {
    const dialog = document.getElementById('categoryDialog');
    if (dialog) {
        dialog.remove();
    }
    selectedOnlineCategories = [];
}

function updateOnlinePlayerList(players) {
    const playerListDiv = document.getElementById('onlinePlayerList');
    if (!playerListDiv) return;
    
    playerListDiv.innerHTML = players.map(player => {
        let labels = '';
        if (player.id === gameState.onlineState.playerId) {
            labels += '<span class="you-label">あなた</span>';
        }
        if (player.isHost) {
            labels += '<span class="host-label">ホスト</span>';
        }
        
        return `
            <div class="player-item ${player.ready ? 'ready' : ''}">
                <span>👤 ${player.name} ${labels}</span>
                <span class="ready-status">${player.ready ? '✅ 準備完了' : '⏳ 待機中'}</span>
            </div>
        `;
    }).join('');
}

function startOnlineQuiz(questions) {
    gameState.questions = questions;
    gameState.currentQuestion = 0;
    gameState.mode = 'online';
    gameState.scores = {};
}

function showOnlineQuestion(data) {
    console.log('オンライン問題表示:', data);
    
    // 現在の問題番号を正確に設定
    gameState.currentQuestion = data.questionNumber - 1;
    gameState.currentAnswers = [];
    gameState.hasAnswered = false;
    
    // サーバーから送られた時間を設定
    if (data.timeLeft !== undefined) {
        gameState.timeLeft = data.timeLeft;
    } else {
        gameState.timeLeft = 15;
    }
    
    // 必ずクイズ画面を表示
    showScreen('quizScreen');
    
    // 問題データを保存
    if (!gameState.questions[gameState.currentQuestion]) {
        gameState.questions[gameState.currentQuestion] = data.question;
    }
    
    document.getElementById('questionText').textContent = data.question.question;
    document.getElementById('questionNumber').textContent = `第${data.questionNumber}問 / ${data.totalQuestions}問`;
    
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = data.question.choices.map((choice, index) => `
        <div class="choice" onclick="selectChoice(${index})">${choice}</div>
    `).join('');
    
    // 回答ログをクリア
    const answerList = document.getElementById('answerList');
    if (answerList) {
        answerList.innerHTML = '<h4>📊 回答状況</h4>';
    }
    
    // タイマー表示を初期化
    updateTimerDisplay();
    
    console.log(`問題${data.questionNumber}を表示しました`);
}

// オンライン用タイマー更新
function updateOnlineTimer(timeLeft) {
    gameState.timeLeft = timeLeft;
    updateTimerDisplay();
}

function handleOnlineAnswerReceived(data) {
    console.log('回答受信:', data);
    
    const answerData = {
        playerId: data.playerId,
        playerName: data.playerName,
        answer: data.answerIndex,
        timeLeft: data.timeLeft,
        order: data.answerOrder
    };
    
    gameState.currentAnswers.push(answerData);
    
    // 回答ログを更新
    const answerList = document.getElementById('answerList');
    if (answerList) {
        const isYou = data.playerId === gameState.onlineState.playerId;
        
        // 既存の内容に追加
        let currentHTML = answerList.innerHTML;
        if (!currentHTML.includes('<h4>📊 回答状況</h4>')) {
            currentHTML = '<h4>📊 回答状況</h4>';
        }
        
        const newAnswerHTML = `
            <div class="answer-item">
                <div>
                    <span class="answer-order">${data.answerOrder}番目</span>
                    <span>👤 ${data.playerName}${isYou ? ' (あなた)' : ''}</span>
                </div>
                <div>
                    <span>⏱️ ${data.timeLeft}秒</span>
                </div>
            </div>
        `;
        
        answerList.innerHTML = currentHTML + newAnswerHTML;
    }
}

function handleOnlineQuestionEnd(data) {
    console.log('問題終了:', data);
    
    const question = data.question;
    const choices = document.querySelectorAll('.choice');
    
    // すべての選択肢を無効化
    choices.forEach(choice => {
        choice.style.pointerEvents = 'none';
        choice.classList.add('disabled');
    });
    
    // 正解を表示
    if (choices[question.correct]) {
        choices[question.correct].classList.add('correct');
    }
    
    // 各プレイヤーの回答結果を表示
    data.results.forEach(result => {
        if (result.answer !== question.correct && result.answer >= 0 && choices[result.answer]) {
            choices[result.answer].classList.add('incorrect');
        }
    });
    
    // 回答ログを更新
    const answerList = document.getElementById('answerList');
    if (answerList) {
        const correctAnswers = data.results.filter(r => r.correct).sort((a, b) => b.timeLeft - a.timeLeft);
        
        let logHTML = '<h4>🏆 回答結果</h4>';
        if (correctAnswers.length > 0) {
            logHTML += correctAnswers.map((result, index) => {
                const isYou = result.playerId === gameState.onlineState.playerId;
                return `
                    <div class="answer-item correct">
                        <div>
                            <span class="answer-order">${index + 1}位</span>
                            <span>👤 ${result.playerName}${isYou ? ' (あなた)' : ''}</span>
                        </div>
                        <div>
                            <span class="answer-points">🏆 +${result.points || 0}pt</span>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            logHTML += '<div class="answer-item">❌ 正解者なし</div>';
        }
        
        answerList.innerHTML = logHTML;
    }
    
    console.log(`問題${gameState.currentQuestion + 1}の結果を表示しました`);
}

function showOnlineResults(finalScores) {
    showScreen('resultScreen');
    
    const sortedScores = finalScores.sort((a, b) => b.score - a.score);
    
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = sortedScores.map((player, index) => {
        const isYou = player.playerId === gameState.onlineState.playerId;
        return `
            <div class="rank-item rank-${Math.min(index + 1, 3)}">
                <div>
                    <span class="rank-number">${index + 1}</span>
                    <span>👤 ${player.playerName}${isYou ? ' (あなた)' : ''}</span>
                </div>
                <div>🏆 ${player.score}ポイント</div>
            </div>
        `;
    }).join('');
}

function leaveOnlineRoom() {
    if (gameState.onlineState.playerId && gameState.onlineState.ws) {
        gameState.onlineState.ws.send(JSON.stringify({
            type: 'leaveRoom',
            playerId: gameState.onlineState.playerId,
            roomId: gameState.onlineState.roomId
        }));
    }
    
    gameState.onlineState.roomId = null;
    gameState.onlineState.playerId = null;
    gameState.onlineState.isHost = false;
    
    showScreen('onlineMenuScreen');
}

// 初期化
function init() {
    console.log('🎯 Quiz Battle Premium 初期化完了');
    
    // CSS keyframesアニメーションの追加
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: var(--shadow-medium); }
            50% { box-shadow: var(--shadow-medium), var(--shadow-glow); }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        @keyframes choiceSelect {
            0% { transform: scale(1); }
            30% { transform: scale(1.05); }
            60% { transform: scale(0.98); }
            100% { transform: scale(1.02); }
        }
        
        @keyframes correctAnswer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes incorrectAnswer {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
    
    // パフォーマンス最適化：画像とフォントのプリロード
    const link = document.createElement('link');
    link.rel = 'preload';
    link.href = 'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap';
    link.as = 'style';
    document.head.appendChild(link);
}

// ページ読み込み完了時に初期化
document.addEventListener('DOMContentLoaded', init);

// パフォーマンス監視（開発用）
if (typeof performance !== 'undefined' && performance.mark) {
    performance.mark('quiz-app-start');
    window.addEventListener('load', () => {
        performance.mark('quiz-app-loaded');
        performance.measure('quiz-app-load-time', 'quiz-app-start', 'quiz-app-loaded');
        console.log('⚡ アプリロード時間:', performance.getEntriesByName('quiz-app-load-time')[0].duration + 'ms');
    });
}
    </script>
</body>
</html>
