<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>早押しクイズバトル - みんなで正解チャンス</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #333;
}

.container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 800px;
    width: 90%;
    transition: all 0.3s ease;
}

h1 {
    text-align: center;
    color: #764ba2;
    margin-bottom: 30px;
    font-size: 2.5em;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.screen {
    display: none;
    animation: fadeIn 0.5s ease;
}

.screen.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* オンライン対戦選択画面 */
.mode-selection {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
}

.mode-card {
    background: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.mode-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.mode-card h3 {
    color: #764ba2;
    margin-bottom: 10px;
}

/* ルーム管理 */
.room-controls {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}

.room-id {
    font-size: 2em;
    font-weight: bold;
    color: #764ba2;
    text-align: center;
    margin: 20px 0;
    padding: 10px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.online-players {
    background: white;
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
    max-height: 300px;
    overflow-y: auto;
}

.online-player {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin: 5px 0;
    background: #f8f9fa;
    border-radius: 5px;
}

.online-player.ready {
    background: #d4edda;
}

/* プレイヤー登録画面 */
.player-input {
    margin-bottom: 15px;
}

.player-input input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
}

.player-input input:focus {
    outline: none;
    border-color: #764ba2;
}

.player-list {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    max-height: 200px;
    overflow-y: auto;
}

.player-item {
    background: white;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

/* カテゴリー選択 */
.category-selection {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.category-item {
    background: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    border: 3px solid transparent;
}

.category-item:hover {
    border-color: #764ba2;
    transform: scale(1.05);
}

.category-item.selected {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-color: #764ba2;
}

/* ボタンスタイル */
.btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-block;
    margin: 10px 5px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.btn:active {
    transform: translateY(0);
}

.btn-danger {
    background: linear-gradient(135deg, #f093fb, #f5576c);
}

.btn-success {
    background: linear-gradient(135deg, #11998e, #38ef7d);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d, #495057);
}

/* 音声コントロール */
.sound-control {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 10px;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    z-index: 1000;
}

.sound-control:hover {
    transform: scale(1.1);
}

/* クイズ画面 */
.quiz-header {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
}

.question-number {
    font-size: 1.2em;
    color: #764ba2;
    margin-bottom: 10px;
}

.timer {
    font-size: 2em;
    font-weight: bold;
    color: #f5576c;
    margin-bottom: 10px;
}

.game-mode-info {
    font-size: 1em;
    color: #11998e;
    font-weight: bold;
    background: rgba(17, 153, 142, 0.1);
    padding: 8px;
    border-radius: 5px;
    margin-top: 10px;
}

.question {
    font-size: 1.4em;
    margin-bottom: 30px;
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
}

.choices {
    display: grid;
    gap: 15px;
    margin-bottom: 30px;
}

.choice {
    background: white;
    border: 3px solid #ddd;
    padding: 20px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    font-size: 1.1em;
    position: relative;
}

.choice:hover {
    border-color: #764ba2;
    transform: scale(1.02);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.choice.correct {
    background: #38ef7d;
    color: white;
    border-color: #11998e;
}

.choice.incorrect {
    background: #f5576c;
    color: white;
    border-color: #f093fb;
}

.choice.disabled {
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
}

/* 回答ログ */
.answer-log {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-top: 20px;
}

.answer-log h4 {
    color: #764ba2;
    margin-bottom: 15px;
    text-align: center;
}

.answer-item {
    background: white;
    padding: 10px 15px;
    margin: 8px 0;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    border-left: 4px solid transparent;
}

.answer-item.correct {
    border-left-color: #38ef7d;
    background: #d4edda;
}

.answer-item.incorrect {
    border-left-color: #f5576c;
    background: #f8d7da;
}

.answer-order {
    font-weight: bold;
    color: #764ba2;
    margin-right: 10px;
}

.answer-points {
    font-weight: bold;
    color: #11998e;
}

/* 結果画面 */
.results {
    background: #f8f9fa;
    padding: 30px;
    border-radius: 15px;
}

.rank-item {
    background: white;
    padding: 20px;
    margin: 15px 0;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s;
}

.rank-item:hover {
    transform: translateX(10px);
}

.rank-1 {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    font-size: 1.3em;
    font-weight: bold;
}

.rank-2 {
    background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
}

.rank-3 {
    background: linear-gradient(135deg, #cd7f32, #e6a85c);
}

.rank-number {
    font-size: 2em;
    font-weight: bold;
    color: #764ba2;
    margin-right: 20px;
}

/* 問題作成画面 */
.question-form {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #764ba2;
}

.form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    outline: none;
    border-color: #764ba2;
}

.question-list {
    max-height: 300px;
    overflow-y: auto;
}

.question-item {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.center {
    text-align: center;
}

/* 接続状態表示 */
.connection-status {
    position: fixed;
    top: 20px;
    left: 20px;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 0.9em;
    font-weight: bold;
    z-index: 1000;
}

.connection-status.connected {
    background: #d4edda;
    color: #155724;
}

.connection-status.disconnected {
    background: #f8d7da;
    color: #721c24;
}

/* アニメーション */
@keyframes bounce {
    0%, 20%, 53%, 80%, 100% {
        transform: translate3d(0,0,0);
    }
    40%, 43% {
        transform: translate3d(0, -30px, 0);
    }
    70% {
        transform: translate3d(0, -15px, 0);
    }
    90% {
        transform: translate3d(0, -4px, 0);
    }
}

.choice.selected {
    animation: bounce 0.8s ease;
}

/* オンライン待機画面のスタイル */
.room-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
    font-size: 1.2em;
    font-weight: bold;
}

.player-section {
    margin: 20px 0;
}

.player-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin: 5px 0;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #ddd;
}

.player-item.ready {
    border-left-color: #28a745;
    background: #d4edda;
}

.ready-status {
    font-size: 0.9em;
    color: #6c757d;
}

.player-item.ready .ready-status {
    color: #155724;
    font-weight: bold;
}

.you-label {
    background: #007bff;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.host-label {
    background: #fd7e14;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

/* レスポンシブ対応 */
@media (max-width: 600px) {
    .container {
        padding: 20px;
    }
    
    h1 {
        font-size: 2em;
    }
    
    .question {
        font-size: 1.2em;
    }

    .mode-selection {
        grid-template-columns: 1fr;
    }
    
    .category-selection {
        grid-template-columns: 1fr 1fr;
    }
    
    .rank-item {
        flex-direction: column;
        text-align: center;
    }
    
    .rank-number {
        margin-bottom: 10px;
        margin-right: 0;
    }
}
    </style>
</head>
<body>
    <!-- 音声コントロール -->
    <div class="sound-control" onclick="toggleSound()" title="音声ON/OFF">
        <span id="soundIcon">🔊</span>
    </div>

    <!-- 接続状態 -->
    <div class="connection-status disconnected" id="connectionStatus" style="display: none;">
        オフライン
    </div>

    <div class="container">
        <h1>🎯 早押しクイズバトル</h1>

        <!-- ホーム画面 -->
        <div id="homeScreen" class="screen active">
            <div class="mode-selection">
                <div class="mode-card" onclick="startLocalGame()">
                    <h3>🏠 ローカル対戦</h3>
                    <p>同じ端末で対戦</p>
                </div>
                <div class="mode-card" onclick="showOnlineMenu()">
                    <h3>🌐 オンライン対戦</h3>
                    <p>離れた場所から対戦</p>
                </div>
            </div>
            <div class="center">
                <button class="btn" onclick="showQuestionCreator()">問題を作成する</button>
            </div>
        </div>

        <!-- オンラインメニュー -->
        <div id="onlineMenuScreen" class="screen">
            <h2>オンライン対戦</h2>
            <div class="room-controls">
                <div class="form-group">
                    <label>プレイヤー名</label>
                    <input type="text" id="onlinePlayerName" placeholder="あなたの名前を入力">
                </div>
                <div class="center">
                    <button class="btn btn-success" onclick="createRoom()">ルームを作成</button>
                    <button class="btn" onclick="showJoinRoom()">ルームに参加</button>
                    <button class="btn btn-danger" onclick="showHome()">戻る</button>
                </div>
            </div>
        </div>

        <!-- ルーム参加画面 -->
        <div id="joinRoomScreen" class="screen">
            <h2>ルームに参加</h2>
            <div class="form-group">
                <label>ルームID</label>
                <input type="text" id="roomIdInput" placeholder="ルームIDを入力">
            </div>
            <div class="center">
                <button class="btn btn-success" onclick="joinRoom()">参加</button>
                <button class="btn btn-danger" onclick="showOnlineMenu()">戻る</button>
            </div>
        </div>

        <!-- オンライン待機室 -->
<div id="onlineWaitingScreen" class="screen">
    <div class="container">
        <h2>オンライン待機室</h2>
        <div id="roomIdDisplay" class="room-info"></div>
        
        <div class="player-section">
            <h3>参加プレイヤー</h3>
            <div id="onlinePlayerList"></div>
        </div>
        
        <div class="button-group">
            <button class="btn btn-primary" onclick="togglePlayerReady()">準備完了/解除</button>
            <button id="startOnlineGameBtn" class="btn btn-success" onclick="startOnlineGame()" style="display: none;">ゲーム開始</button>
            <button class="btn btn-secondary" onclick="leaveOnlineRoom()">ルーム退出</button>
        </div>
    </div>
</div>

        <!-- プレイヤー登録画面（ローカル） -->
        <div id="playerScreen" class="screen">
            <h2>プレイヤー登録</h2>
            <div class="player-input">
                <input type="text" id="playerName" placeholder="プレイヤー名を入力" onkeypress="if(event.key==='Enter')addPlayer()">
            </div>
            <button class="btn btn-success" onclick="addPlayer()">プレイヤーを追加</button>
            
            <div class="player-list">
                <h3>参加プレイヤー</h3>
                <div id="playerList"></div>
            </div>
            
            <div class="center">
                <button class="btn" onclick="showCategorySelection()" id="startBtn" style="display:none;">次へ</button>
                <button class="btn btn-danger" onclick="showHome()">戻る</button>
            </div>
        </div>

        <!-- カテゴリー選択画面 -->
        <div id="categoryScreen" class="screen">
            <h2>カテゴリー選択</h2>
            <p>出題するカテゴリーを選択してください（複数選択可）</p>
            <div class="category-selection" id="categorySelection">
                <div class="category-item" data-category="general" onclick="toggleCategory('general')">
                    <h4>📚 一般常識</h4>
                </div>
                <div class="category-item" data-category="geography" onclick="toggleCategory('geography')">
                    <h4>🌏 地理</h4>
                </div>
                <div class="category-item" data-category="history" onclick="toggleCategory('history')">
                    <h4>📜 歴史</h4>
                </div>
                <div class="category-item" data-category="science" onclick="toggleCategory('science')">
                    <h4>🔬 科学</h4>
                </div>
                <div class="category-item" data-category="sports" onclick="toggleCategory('sports')">
                    <h4>⚽ スポーツ</h4>
                </div>
                <div class="category-item" data-category="entertainment" onclick="toggleCategory('entertainment')">
                    <h4>🎬 エンタメ</h4>
                </div>
                <div class="category-item" data-category="custom" onclick="toggleCategory('custom')">
                    <h4>✏️ カスタム</h4>
                </div>
            </div>
            <div class="center">
                <button class="btn btn-success" onclick="startGameWithCategories()">ゲーム開始</button>
                <button class="btn btn-danger" onclick="showPlayerRegistration()">戻る</button>
            </div>
        </div>

        <!-- クイズ画面 -->
        <div id="quizScreen" class="screen">
            <div class="quiz-header">
                <div class="question-number" id="questionNumber">第1問 / 6問</div>
                <div class="timer" id="timer">15</div>
                <div class="game-mode-info">正解者全員にポイント！早い順により多くのポイント！</div>
            </div>
            
            <div class="question" id="questionText">問題文がここに表示されます</div>
            
            <div class="choices" id="choices">
                <div class="choice" onclick="selectChoice(0)">選択肢1</div>
                <div class="choice" onclick="selectChoice(1)">選択肢2</div>
                <div class="choice" onclick="selectChoice(2)">選択肢3</div>
            </div>
            
            <!-- 回答者表示エリア -->
            <div class="answer-log" id="answerLog">
                <h4>回答状況</h4>
                <div id="answerList"></div>
            </div>
        </div>

        <!-- 結果画面 -->
        <div id="resultScreen" class="screen">
            <h2>🏆 最終結果</h2>
            <div class="results" id="results"></div>
            <div class="center">
                <button class="btn" onclick="resetGame()">もう一度プレイ</button>
                <button class="btn btn-danger" onclick="showHome()">ホームに戻る</button>
            </div>
        </div>

        <!-- 問題作成画面 -->
        <div id="questionCreatorScreen" class="screen">
            <h2>問題作成</h2>
            <div class="question-form">
                <div class="form-group">
                    <label>カテゴリー</label>
                    <select id="questionCategory">
                        <option value="general">一般常識</option>
                        <option value="geography">地理</option>
                        <option value="history">歴史</option>
                        <option value="science">科学</option>
                        <option value="sports">スポーツ</option>
                        <option value="entertainment">エンタメ</option>
                        <option value="custom">カスタム</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>問題文</label>
                    <textarea id="newQuestion" placeholder="問題文を入力してください"></textarea>
                </div>
                <div class="form-group">
                    <label>選択肢1</label>
                    <input type="text" id="choice1" placeholder="選択肢1を入力">
                </div>
                <div class="form-group">
                    <label>選択肢2</label>
                    <input type="text" id="choice2" placeholder="選択肢2を入力">
                </div>
                <div class="form-group">
                    <label>選択肢3</label>
                    <input type="text" id="choice3" placeholder="選択肢3を入力">
                </div>
                <div class="form-group">
                    <label>正解の選択肢番号（1-3）</label>
                    <input type="number" id="correctAnswer" min="1" max="3" placeholder="1">
                </div>
                <button class="btn btn-success" onclick="addQuestion()">問題を追加</button>
            </div>
            
            <div class="question-list">
                <h3>登録済みの問題</h3>
                <div id="questionList"></div>
            </div>
            
            <div class="center">
                <button class="btn btn-danger" onclick="showHome()">戻る</button>
            </div>
        </div>
    </div>

    <script>
// ゲーム状態
let gameState = {
   mode: 'local', // local, online
   players: [],
   currentQuestion: 0,
   questions: [],
   timer: null,
   timeLeft: 15,
   scores: {},
   selectedCategories: [],
   soundEnabled: true,
   currentAnswers: [],
   onlineState: {
       ws: null,
       roomId: null,
       playerId: null,
       isHost: false,
       connected: false
   }
};

// 音声管理
const sounds = {
    correct: new Audio('data:audio/wav;base64,UklGRi4CAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoCAAC5wMTBxL6/v7fAvsHAv7+/v7+/v7+/v7+/v8C7wb3Bvb6/vL+8v73AvMC+vb+9vr2/vL69wLy/vL+9wL6/vr6/wL/AvsG/wMDAwMDBwcDAwcDBwcHCwcLBw8LDw8PDw8TExMTFxMXFxcXGxsbGx8bHx8fHyMfIyMnIycnJycnKysrKy8vLy8zMzMzNzM3Nzs3Ozs7Ozs/O0M/Q0M/Q0NDR0dHR0tHR0tLS0tLS09PT09TU1NTU1dTU1dXV1dYAAAC5wMTBxL6/v7fAvsHAv7+/v7+/v7+/v7+/v8C7wb3Bvb6/vL+8v73AvMC+vb+9vr2/vL69wLy/vL+9wL6/vr6/wL/AvsG/wMDAwMDBwcDAwcDBwcHCwcLBw8LDw8PDw8TExMTFxMXFxcXGxsbGx8bHx8fHyMfIyMnIycnJycnKysrKy8vLy8zMzMzNzM3Nzs3Ozs7Ozs/O0M/Q0M/Q0NDR0dHR0tHR0tLS0tLS09PT09TU1NTU1dTU1dXV1dY='),
    incorrect: new Audio('data:audio/wav;base64,UklGRhwCAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YfgBAADPz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Pz8/Qz9DP0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0'),
    start: new Audio('data:audio/wav;base64,UklGRhwDAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YfgCAABhYWBhYGFgYWBhYGFgYWBgYGBhYGFgYWBhYGFgYWBhYGFgYWBhYGFgYWBhYGFgYWBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBg')
};        
        
// デフォルト問題
const defaultQuestions = [
   {
       question: "日本の首都はどこですか？",
       choices: ["大阪", "東京", "京都"],
       correct: 1,
       category: "general"
   },
   {
       question: "富士山の高さは？",
       choices: ["3,776m", "3,676m", "3,876m"],
       correct: 0,
       category: "geography"
   },
   {
       question: "鎌倉幕府を開いたのは誰？",
       choices: ["源頼朝", "足利尊氏", "徳川家康"],
       correct: 0,
       category: "history"
   },
   {
       question: "水の化学式は？",
       choices: ["CO2", "H2O", "O2"],
       correct: 1,
       category: "science"
   },
   {
       question: "地球で最も大きな大陸は？",
       choices: ["アフリカ大陸", "アジア大陸", "北アメリカ大陸"],
       correct: 1,
       category: "geography"
   },
   {
       question: "光の速度はおよそ？",
       choices: ["秒速30万km", "秒速3万km", "秒速300万km"],
       correct: 0,
       category: "science"
   },
   {
       question: "東京オリンピック2020の開催年は？",
       choices: ["2020年", "2021年", "2022年"],
       correct: 1,
       category: "sports"
   },
   {
       question: "源氏物語の作者は？",
       choices: ["清少納言", "紫式部", "sei shonagon"],
       correct: 1,
       category: "history"
   },
   {
       question: "ジブリ作品「千と千尋の神隠し」の監督は？",
       choices: ["宮崎駿", "高畑勲", "細田守"],
       correct: 0,
       category: "entertainment"
   },
   {
       question: "DNA の正式名称は？",
       choices: ["デオキシリボ核酸", "リボ核酸", "アミノ酸"],
       correct: 0,
       category: "science"
   },
   {
       question: "日本で最も長い川は？",
       choices: ["利根川", "信濃川", "石狩川"],
       correct: 1,
       category: "geography"
   },
   {
       question: "太陽系で最も大きな惑星は？",
       choices: ["土星", "木星", "海王星"],
       correct: 1,
       category: "science"
   },
   {
       question: "1964年の東京オリンピックの開催月は？",
       choices: ["9月", "10月", "11月"],
       correct: 1,
       category: "sports"
   },
   {
       question: "世界で最も高い山は？",
       choices: ["K2", "エベレスト", "マナスル"],
       correct: 1,
       category: "geography"
   },
   {
       question: "漢字で「山」の部首は？",
       choices: ["やまへん", "やまかんむり", "やま"],
       correct: 2,
       category: "general"
   }
];

// カテゴリ管理
const categories = {
   general: { name: '一般常識', color: '#007bff' },
   history: { name: '歴史', color: '#dc3545' },
   science: { name: '科学', color: '#28a745' },
   geography: { name: '地理', color: '#ffc107' },
   sports: { name: 'スポーツ', color: '#fd7e14' },
   entertainment: { name: 'エンタメ', color: '#6f42c1' }
};

// 音声管理
function playSound(type) {
   if (!gameState.soundEnabled) return;
   
   try {
       if (sounds[type]) {
           sounds[type].currentTime = 0;
           sounds[type].play().catch(e => console.log('音声再生エラー:', e));
       }
   } catch (error) {
       console.log('音声エラー:', error);
   }
}

// 初期化
function init() {
   initEventListeners();
   initWebSocket();
   showScreen('mainMenu');
   updateConnectionStatus(false);
}

// イベントリスナー設定
function initEventListeners() {
   // 音声設定
   const soundToggle = document.getElementById('soundToggle');
   if (soundToggle) {
       soundToggle.addEventListener('change', (e) => {
           gameState.soundEnabled = e.target.checked;
       });
   }

   // プレイヤー追加
   const addPlayerBtn = document.getElementById('addPlayerBtn');
   if (addPlayerBtn) {
       addPlayerBtn.addEventListener('click', addPlayer);
   }

   // Enter キーでプレイヤー追加
   const playerNameInput = document.getElementById('playerNameInput');
   if (playerNameInput) {
       playerNameInput.addEventListener('keypress', (e) => {
           if (e.key === 'Enter') {
               addPlayer();
           }
       });
   }
}

// 画面切り替え
function showScreen(screenId) {
   if (screenId !== 'quizScreen') {
       stopTimer();
   }
   
   const screens = document.querySelectorAll('.screen');
   screens.forEach(screen => screen.classList.remove('active'));
   
   const targetScreen = document.getElementById(screenId);
   if (targetScreen) {
       targetScreen.classList.add('active');
   }
   
   document.body.style.opacity = '0';
   setTimeout(() => {
       document.body.style.opacity = '1';
   }, 100);
}

// ローカル対戦設定
function showLocalGameSetup() {
   showScreen('localGameSetup');
   updateCategoryCheckboxes();
}

// オンライン対戦メニュー
function showOnlineMenu() {
   showScreen('onlineMenuScreen');
}

// メインメニューに戻る
function backToMainMenu() {
   gameState.players = [];
   gameState.scores = {};
   gameState.currentQuestion = 0;
   gameState.selectedCategories = [];
   stopTimer();
   showScreen('mainMenu');
}

// プレイヤー追加
function addPlayer() {
   const input = document.getElementById('playerNameInput');
   const playerName = input.value.trim();
   
   if (!playerName) {
       alert('プレイヤー名を入力してください');
       return;
   }
   
   if (gameState.players.some(player => player.name === playerName)) {
       alert('同じ名前のプレイヤーがすでに存在します');
       return;
   }
   
   if (gameState.players.length >= 6) {
       alert('プレイヤーは最大6人までです');
       return;
   }
   
   const player = {
       id: Date.now(),
       name: playerName
   };
   
   gameState.players.push(player);
   gameState.scores[player.id] = 0;
   
   input.value = '';
   updatePlayerList();
   
   playSound('correct');
}

// プレイヤーリスト更新
function updatePlayerList() {
   const playerList = document.getElementById('playerList');
   if (!playerList) return;
   
   playerList.innerHTML = gameState.players.map((player, index) => `
       <div class="player-item">
           <span>${player.name}</span>
           <button class="btn-remove" onclick="removePlayer(${player.id})">削除</button>
       </div>
   `).join('');
}

// プレイヤー削除
function removePlayer(playerId) {
   gameState.players = gameState.players.filter(player => player.id !== playerId);
   delete gameState.scores[playerId];
   updatePlayerList();
}

// カテゴリチェックボックス更新
function updateCategoryCheckboxes() {
   const categoryContainer = document.getElementById('categorySelection');
   if (!categoryContainer) return;
   
   categoryContainer.innerHTML = Object.entries(categories).map(([key, category]) => `
       <label class="category-checkbox">
           <input type="checkbox" value="${key}" onchange="toggleCategory('${key}')">
           <span style="color: ${category.color}">${category.name}</span>
       </label>
   `).join('');
}

// カテゴリ選択切り替え
function toggleCategory(categoryKey) {
   const index = gameState.selectedCategories.indexOf(categoryKey);
   if (index === -1) {
       gameState.selectedCategories.push(categoryKey);
   } else {
       gameState.selectedCategories.splice(index, 1);
   }
}

// ローカルクイズ開始
function startLocalQuiz() {
   if (gameState.players.length < 2) {
       alert('最低2人のプレイヤーが必要です');
       return;
   }
   
   let questions = [...defaultQuestions];
   
   if (gameState.selectedCategories.length > 0) {
       questions = questions.filter(q => gameState.selectedCategories.includes(q.category));
   }
   
   if (questions.length < 6) {
       alert('選択したカテゴリの問題が少なすぎます');
       return;
   }
   
   gameState.questions = shuffleArray(questions).slice(0, 6);
   gameState.currentQuestion = 0;
   gameState.mode = 'local';
   
   gameState.players.forEach(player => {
       gameState.scores[player.id] = 0;
   });
   
   playSound('start');
   showQuestion();
}

// 配列シャッフル
function shuffleArray(array) {
   const newArray = [...array];
   for (let i = newArray.length - 1; i > 0; i--) {
       const j = Math.floor(Math.random() * (i + 1));
       [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
   }
   return newArray;
}

// 問題表示
function showQuestion() {
   stopTimer();
   
   if (gameState.currentQuestion >= gameState.questions.length) {
       showResults();
       return;
   }
   
   const question = gameState.questions[gameState.currentQuestion];
   gameState.currentAnswers = [];
   
   showScreen('quizScreen');
   
   document.getElementById('questionText').textContent = question.question;
   document.getElementById('questionNumber').textContent = `問題 ${gameState.currentQuestion + 1} / ${gameState.questions.length}`;
   
   const choicesDiv = document.getElementById('choices');
   choicesDiv.innerHTML = question.choices.map((choice, index) => `
       <button class="choice" onclick="selectChoice(${index})">${choice}</button>
   `).join('');
   
   document.getElementById('answerList').innerHTML = '';
   
   setTimeout(() => {
       startTimer();
   }, 100);
}

// タイマー開始
function startTimer() {
   if (gameState.timer) {
       clearInterval(gameState.timer);
       gameState.timer = null;
   }
   
   const timerElement = document.getElementById('timer');
   if (!timerElement) return;
   
   gameState.timeLeft = 15;
   updateTimerDisplay();
   
   gameState.timer = setInterval(() => {
       gameState.timeLeft--;
       updateTimerDisplay();
       
       if (gameState.timeLeft <= 0) {
           clearInterval(gameState.timer);
           gameState.timer = null;
           handleTimeUp();
       }
   }, 1000);
}

// タイマー表示更新
function updateTimerDisplay() {
   const timerElement = document.getElementById('timer');
   if (timerElement) {
       timerElement.textContent = `残り時間: ${Math.max(0, gameState.timeLeft)}秒`;
       
       if (gameState.timeLeft <= 5) {
           timerElement.style.color = '#dc3545';
       } else if (gameState.timeLeft <= 10) {
           timerElement.style.color = '#ffc107';
       } else {
           timerElement.style.color = '#28a745';
       }
   }
}

// 時間切れ処理
function handleTimeUp() {
   if (gameState.mode === 'online') {
       return;
   }
   
   const choices = document.querySelectorAll('.choice');
   choices.forEach(choice => choice.disabled = true);
   
   setTimeout(() => {
       nextQuestion();
   }, 2000);
}

// タイマー停止
function stopTimer() {
   if (gameState.timer) {
       clearInterval(gameState.timer);
       gameState.timer = null;
   }
}

// 選択肢選択
function selectChoice(index) {
   stopTimer();
   
   const choices = document.querySelectorAll('.choice');
   choices.forEach(choice => choice.disabled = true);
   choices[index].classList.add('selected');
   
   const question = gameState.questions[gameState.currentQuestion];
   const isCorrect = index === question.correct;
   
   const answerData = {
       player: 'ローカルプレイヤー',
       answer: index,
       correct: isCorrect,
       timeLeft: gameState.timeLeft
   };
   
   gameState.currentAnswers.push(answerData);
   
   if (isCorrect) {
       choices[index].classList.add('correct');
       playSound('correct');
   } else {
       choices[index].classList.add('incorrect');
       choices[question.correct].classList.add('correct');
       playSound('incorrect');
   }
   
   updateAnswerLog();
   
   setTimeout(() => {
       nextQuestion();
   }, 2000);
}

// 回答ログ更新
function updateAnswerLog() {
   const answerList = document.getElementById('answerList');
   if (!answerList) return;
   
   answerList.innerHTML = gameState.currentAnswers.map((answer, index) => `
       <div class="answer-log ${answer.correct ? 'correct' : 'incorrect'}">
           <span>${index + 1}位: ${answer.player}</span>
           <span>${answer.correct ? '正解' : '不正解'} (${answer.timeLeft}秒)</span>
       </div>
   `).join('');
}

// 次の問題
function nextQuestion() {
   gameState.currentQuestion++;
   if (gameState.currentQuestion >= gameState.questions.length) {
       showResults();
   } else {
       showQuestion();
   }
}

// 結果表示
function showResults() {
   stopTimer();
   showScreen('resultScreen');
   
   const sortedPlayers = gameState.players.sort((a, b) => 
       gameState.scores[b.id] - gameState.scores[a.id]
   );
   
   const resultsDiv = document.getElementById('results');
   resultsDiv.innerHTML = sortedPlayers.map((player, index) => `
       <div class="rank-item rank-${Math.min(index + 1, 3)}">
           <div>
               <span class="rank-number">${index + 1}位</span>
               <span>${player.name}</span>
           </div>
           <div>${gameState.scores[player.id]}ポイント</div>
       </div>
   `).join('');
}

// WebSocket接続管理
function initWebSocket() {
   const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
   
   let wsUrl;
   if (isProduction) {
       const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
       wsUrl = `${protocol}//${window.location.host}`;
   } else {
       wsUrl = 'ws://localhost:8080';
   }
   
   console.log('WebSocket接続先:', wsUrl);
   
   try {
       gameState.onlineState.ws = new WebSocket(wsUrl);
       
       gameState.onlineState.ws.onopen = () => {
           console.log('WebSocket接続成功');
           updateConnectionStatus(true);
       };
       
       gameState.onlineState.ws.onclose = () => {
           console.log('WebSocket接続切断');
           updateConnectionStatus(false);
       };
       
       gameState.onlineState.ws.onmessage = (event) => {
           handleWebSocketMessage(JSON.parse(event.data));
       };
       
       gameState.onlineState.ws.onerror = (error) => {
           console.error('WebSocketエラー:', error);
           updateConnectionStatus(false);
       };
   } catch (error) {
       console.error('WebSocket接続失敗:', error);
       updateConnectionStatus(false);
   }
}

function handleWebSocketMessage(data) {
   console.log('受信:', data);
   
   switch(data.type) {
       case 'roomCreated':
           gameState.onlineState.roomId = data.roomId;
           gameState.onlineState.playerId = data.playerId;
           gameState.onlineState.isHost = true;
           document.getElementById('roomIdDisplay').textContent = `ルームID: ${data.roomId}`;
           showScreen('onlineWaitingScreen');
           updateOnlinePlayerList(data.players);
           document.getElementById('startOnlineGameBtn').style.display = 'block';
           break;
           
       case 'joinedRoom':
           gameState.onlineState.roomId = data.roomId;
           gameState.onlineState.playerId = data.playerId;
           gameState.onlineState.isHost = false;
           showScreen('onlineWaitingScreen');
           document.getElementById('startOnlineGameBtn').style.display = 'none';
           break;
           
       case 'playerJoined':
       case 'playerLeft':
       case 'playerReady':
           updateOnlinePlayerList(data.players);
           if (data.type === 'playerLeft' && gameState.onlineState.isHost) {
               document.getElementById('startOnlineGameBtn').style.display = 'block';
           }
           break;
           
       case 'newHost':
           if (data.hostId === gameState.onlineState.playerId) {
               gameState.onlineState.isHost = true;
               document.getElementById('startOnlineGameBtn').style.display = 'block';
           }
           break;
           
       case 'gameStart':
           startOnlineQuiz(data.questions);
           break;
           
       case 'newQuestion':
           showOnlineQuestion(data);
           break;
           
       case 'answerResult':
           handleOnlineAnswerResult(data);
           break;
           
       case 'gameEnd':
           showOnlineResults(data.scores);
           break;
           
       case 'error':
           alert(data.message);
           break;
   }
}

// 接続状態更新
function updateConnectionStatus(connected) {
   gameState.onlineState.connected = connected;
   const statusDiv = document.getElementById('connectionStatus');
   if (statusDiv) {
       statusDiv.textContent = connected ? '✅ サーバーに接続中' : '❌ サーバーに未接続';
       statusDiv.className = connected ? 'connection-status connected' : 'connection-status disconnected';
   }
}

// ルーム作成
function createOnlineRoom() {
   const playerName = document.getElementById('onlinePlayerName').value.trim();
   if (!playerName) {
       alert('プレイヤー名を入力してください');
       return;
   }
   
   if (!gameState.onlineState.ws || gameState.onlineState.ws.readyState !== WebSocket.OPEN) {
       alert('サーバーに接続されていません');
       return;
   }
   
   gameState.onlineState.ws.send(JSON.stringify({
       type: 'createRoom',
       playerName: playerName
   }));
}

// ルーム参加
function joinOnlineRoom() {
   const playerName = document.getElementById('onlinePlayerName').value.trim();
   const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
   
   if (!playerName) {
       alert('プレイヤー名を入力してください');
       return;
   }
   
   if (!roomId) {
       alert('ルームIDを入力してください');
       return;
   }
   
   if (!gameState.onlineState.ws || gameState.onlineState.ws.readyState !== WebSocket.OPEN) {
       alert('サーバーに接続されていません');
       return;
   }
   
   gameState.onlineState.ws.send(JSON.stringify({
       type: 'joinRoom',
       playerName: playerName,
       roomId: roomId
   }));
}

// プレイヤー準備状態切り替え
function togglePlayerReady() {
   if (!gameState.onlineState.playerId || !gameState.onlineState.ws) {
       return;
   }
   
   gameState.onlineState.ws.send(JSON.stringify({
       type: 'ready',
       playerId: gameState.onlineState.playerId
   }));
}

// オンラインゲーム開始
function startOnlineGame() {
   if (!gameState.onlineState.isHost) {
       alert('ホストのみがゲームを開始できます');
       return;
   }
   
   if (!gameState.onlineState.roomId || !gameState.onlineState.playerId) {
       alert('ルーム情報が正しくありません');
       return;
   }
   
   console.log('ゲーム開始リクエスト送信:', {
       roomId: gameState.onlineState.roomId,
       playerId: gameState.onlineState.playerId,
       isHost: gameState.onlineState.isHost
   });
   
   gameState.onlineState.ws.send(JSON.stringify({
       type: 'startGame',
       roomId: gameState.onlineState.roomId,
       playerId: gameState.onlineState.playerId
   }));
}

// オンラインプレイヤーリスト更新
function updateOnlinePlayerList(players) {
   const playerListDiv = document.getElementById('onlinePlayerList');
   if (!playerListDiv) return;
   
   playerListDiv.innerHTML = players.map(player => `
       <div class="player-item ${player.ready ? 'ready' : ''}">
           <span>${player.name}</span>
           <span class="ready-status">${player.ready ? '準備完了' : '待機中'}</span>
           ${player.id === gameState.onlineState.playerId ? '<span class="you-label">(あなた)</span>' : ''}
           ${player.id === gameState.onlineState.roomId ? '<span class="host-label">(ホスト)</span>' : ''}
       </div>
   `).join('');
}

// オンライン問題表示
function showOnlineQuestion(data) {
   stopTimer();
   
   gameState.currentQuestion = data.questionNumber - 1;
   gameState.questions = [data.question];
   gameState.currentAnswers = [];
   
   showScreen('quizScreen');
   
   document.getElementById('questionText').textContent = data.question.question;
   document.getElementById('questionNumber').textContent = `問題 ${data.questionNumber} / ${data.totalQuestions}`;
   
   const choicesDiv = document.getElementById('choices');
   choicesDiv.innerHTML = data.question.choices.map((choice, index) => `
       <button class="choice" onclick="selectOnlineChoice(${index})">${choice}</button>
   `).join('');
   
   document.getElementById('answerList').innerHTML = '';
   
   setTimeout(() => {
       startTimer();
   }, 100);
}

// オンライン選択肢選択
function selectOnlineChoice(index) {
   if (gameState.currentAnswers.some(answer => answer.player === 'あなた')) {
       return;
   }
   
   stopTimer();
   
   const choices = document.querySelectorAll('.choice');
   choices.forEach(choice => choice.disabled = true);
   choices[index].classList.add('selected');
   
   gameState.onlineState.ws.send(JSON.stringify({
       type: 'selectAnswer',
       roomId: gameState.onlineState.roomId,
       playerId: gameState.onlineState.playerId,
       answerIndex: index
   }));
}

// オンライン回答結果処理
function handleOnlineAnswerResult(data) {
   const answerData = {
       player: data.playerName === getCurrentPlayerName() ? 'あなた' : data.playerName,
       answer: data.answerIndex,
       correct: data.correct,
       timeLeft: gameState.timeLeft,
       order: data.currentAnswers.filter(a => a.correct).length
   };
   
   gameState.currentAnswers.push(answerData);
   
   const choices = document.querySelectorAll('.choice');
   if (data.correct) {
       choices[data.answerIndex].classList.add('correct');
       playSound('correct');
   } else {
       choices[data.answerIndex].classList.add('incorrect');
       playSound('incorrect');
   }
   
   updateAnswerLog();
}

// 現在のプレイヤー名を取得
function getCurrentPlayerName() {
   return document.getElementById('onlinePlayerName').value.trim();
}

// オンライン結果表示
function showOnlineResults(scores) {
   stopTimer();
   showScreen('resultScreen');
   
   const resultsDiv = document.getElementById('results');
   resultsDiv.innerHTML = scores.map((player, index) => `
       <div class="rank-item rank-${Math.min(index + 1, 3)}">
           <div>
               <span class="rank-number">${index + 1}位</span>
               <span>${player.playerName}${player.playerId === gameState.onlineState.playerId ? ' (あなた)' : ''}</span>
           </div>
           <div>${player.score}ポイント</div>
       </div>
   `).join('');
}

// オンラインクイズ開始
function startOnlineQuiz(questions) {
   gameState.questions = questions;
   gameState.currentQuestion = 0;
   gameState.mode = 'online';
   
   playSound('start');
}

// ルーム退出
function leaveOnlineRoom() {
   if (gameState.onlineState.playerId && gameState.onlineState.ws) {
       gameState.onlineState.ws.send(JSON.stringify({
           type: 'leaveRoom',
           playerId: gameState.onlineState.playerId
       }));
   }
   
   gameState.onlineState.roomId = null;
   gameState.onlineState.playerId = null;
   gameState.onlineState.isHost = false;
   
   showScreen('onlineMenuScreen');
}

// ページ離脱時にタイマーをクリア
window.addEventListener('beforeunload', () => {
   stopTimer();
});

// タブが非アクティブになった時にタイマーを停止
document.addEventListener('visibilitychange', () => {
   if (document.hidden && gameState.mode === 'online') {
       stopTimer();
   }
});

// ページ読み込み完了時に初期化
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
